{"version":3,"file":"AICompletionProvider.js","sources":["../../../src/features/ai/AICompletionProvider.ts"],"sourcesContent":["/**\n * AI 代码补全提供器\n * 集成到 Monaco Editor 的补全系统\n */\n\nimport type * as Monaco from 'monaco-editor'\nimport type { AIService } from './AIService'\nimport type { CodeContext, AICompletionItem } from '../../types/ai'\nimport { ContextAnalyzer } from './ContextAnalyzer'\n\nexport interface AICompletionProviderOptions {\n  aiService: AIService\n  triggerCharacters?: string[]\n  debounceDelay?: number\n  maxSuggestions?: number\n  enableInlineCompletion?: boolean\n}\n\n/**\n * AI 代码补全提供器类\n */\nexport class AICompletionProvider {\n  private aiService: AIService\n  private contextAnalyzer: ContextAnalyzer\n  private options: Required<AICompletionProviderOptions>\n  private debounceTimer: ReturnType<typeof setTimeout> | null = null\n\n  constructor(options: AICompletionProviderOptions) {\n    this.aiService = options.aiService\n    this.contextAnalyzer = new ContextAnalyzer()\n    this.options = {\n      aiService: options.aiService,\n      triggerCharacters: options.triggerCharacters || ['.', '(', ' '],\n      debounceDelay: options.debounceDelay || 300,\n      maxSuggestions: options.maxSuggestions || 5,\n      enableInlineCompletion: options.enableInlineCompletion !== false,\n    }\n  }\n\n  /**\n   * 注册到 Monaco Editor\n   */\n  register(monaco: typeof Monaco, language: string): Monaco.IDisposable {\n    return monaco.languages.registerCompletionItemProvider(language, {\n      triggerCharacters: this.options.triggerCharacters,\n\n      provideCompletionItems: async (model, position, _context, token) => {\n        return new Promise((resolve) => {\n          // 清除之前的计时器\n          if (this.debounceTimer) {\n            clearTimeout(this.debounceTimer)\n          }\n\n          // 防抖\n          this.debounceTimer = setTimeout(async () => {\n            if (token.isCancellationRequested) {\n              resolve({ suggestions: [] })\n              return\n            }\n\n            try {\n              const context = this.contextAnalyzer.analyzeContext(model, position)\n              const suggestions = await this.getAICompletions(context)\n\n              const monacoSuggestions: Monaco.languages.CompletionItem[] = suggestions.map((item) => ({\n                label: item.displayText || item.text,\n                kind: this.mapKind(item.kind),\n                insertText: item.text,\n                documentation: item.documentation,\n                sortText: `${1000 - item.score}`,\n                range: {\n                  startLineNumber: position.lineNumber,\n                  startColumn: position.column,\n                  endLineNumber: position.lineNumber,\n                  endColumn: position.column,\n                },\n              }))\n\n              resolve({\n                suggestions: monacoSuggestions,\n              })\n            } catch (error) {\n              console.error('AI completion error:', error)\n              resolve({ suggestions: [] })\n            }\n          }, this.options.debounceDelay)\n        })\n      },\n    })\n  }\n\n  /**\n   * 注册内联补全\n   */\n  registerInlineCompletion(monaco: typeof Monaco, language: string): Monaco.IDisposable | null {\n    if (!this.options.enableInlineCompletion) {\n      return null\n    }\n\n    // Monaco Editor v0.34+ 支持内联补全\n    if (!monaco.languages.registerInlineCompletionsProvider) {\n      return null\n    }\n\n    return monaco.languages.registerInlineCompletionsProvider(language, {\n      provideInlineCompletions: async (model, position, _context, token) => {\n        if (token.isCancellationRequested) {\n          return { items: [] }\n        }\n\n        try {\n          const context = this.contextAnalyzer.analyzeContext(model, position)\n          const completion = await this.aiService.getCompletion({\n            prompt: context.beforeCursor,\n            context: this.buildContextString(context),\n            language: context.language,\n          })\n\n          return {\n            items: [\n              {\n                insertText: completion.completion,\n                range: {\n                  startLineNumber: position.lineNumber,\n                  startColumn: position.column,\n                  endLineNumber: position.lineNumber,\n                  endColumn: position.column,\n                },\n              },\n            ],\n          }\n        } catch (error) {\n          console.error('AI inline completion error:', error)\n          return { items: [] }\n        }\n      },\n\n      freeInlineCompletions: () => {\n        // 清理资源\n      },\n    })\n  }\n\n  /**\n   * 获取 AI 补全\n   */\n  private async getAICompletions(context: CodeContext): Promise<AICompletionItem[]> {\n    try {\n      const response = await this.aiService.getCompletion({\n        prompt: context.beforeCursor,\n        context: this.buildContextString(context),\n        language: context.language,\n        maxTokens: 50,\n      })\n\n      // 解析补全结果\n      const items: AICompletionItem[] = [\n        {\n          text: response.completion,\n          displayText: response.completion.split('\\n')[0],\n          documentation: 'AI-generated completion',\n          kind: this.inferKind(response.completion),\n          score: (response.confidence || 0.5) * 100,\n        },\n      ]\n\n      // 添加替代建议\n      if (response.alternatives) {\n        response.alternatives.forEach((alt, index) => {\n          items.push({\n            text: alt,\n            displayText: alt.split('\\n')[0],\n            documentation: 'AI-generated alternative',\n            kind: this.inferKind(alt),\n            score: (response.confidence || 0.5) * 100 - (index + 1) * 10,\n          })\n        })\n      }\n\n      return items.slice(0, this.options.maxSuggestions)\n    } catch (error) {\n      console.error('Failed to get AI completions:', error)\n      return []\n    }\n  }\n\n  /**\n   * 构建上下文字符串\n   */\n  private buildContextString(context: CodeContext): string {\n    let contextStr = ''\n\n    if (context.imports && context.imports.length > 0) {\n      contextStr += `Imports: ${context.imports.join(', ')}\\n`\n    }\n\n    if (context.functions && context.functions.length > 0) {\n      contextStr += `Functions: ${context.functions.join(', ')}\\n`\n    }\n\n    if (context.variables && context.variables.length > 0) {\n      contextStr += `Variables: ${context.variables.join(', ')}\\n`\n    }\n\n    return contextStr\n  }\n\n  /**\n   * 推断补全类型\n   */\n  private inferKind(text: string): AICompletionItem['kind'] {\n    if (text.includes('function') || text.includes('=>')) {\n      return 'function'\n    }\n    if (text.includes('class')) {\n      return 'class'\n    }\n    if (text.includes('const') || text.includes('let') || text.includes('var')) {\n      return 'variable'\n    }\n    if (text.includes('(') && text.includes(')')) {\n      return 'method'\n    }\n    return 'snippet'\n  }\n\n  /**\n   * 映射到 Monaco 类型\n   */\n  private mapKind(kind: AICompletionItem['kind']): Monaco.languages.CompletionItemKind {\n    const monaco = (globalThis as { monaco?: typeof Monaco }).monaco\n\n    if (!monaco) {\n      return 0\n    }\n\n    const kindMap: Record<AICompletionItem['kind'], Monaco.languages.CompletionItemKind> = {\n      method: monaco.languages.CompletionItemKind.Method,\n      function: monaco.languages.CompletionItemKind.Function,\n      property: monaco.languages.CompletionItemKind.Property,\n      variable: monaco.languages.CompletionItemKind.Variable,\n      class: monaco.languages.CompletionItemKind.Class,\n      snippet: monaco.languages.CompletionItemKind.Snippet,\n    }\n\n    return kindMap[kind] || monaco.languages.CompletionItemKind.Text\n  }\n\n  /**\n   * 清理资源\n   */\n  dispose(): void {\n    if (this.debounceTimer) {\n      clearTimeout(this.debounceTimer)\n      this.debounceTimer = null\n    }\n  }\n}\n\n"],"names":["p","Object","defineProperty","a","r","e","n","enumerable","configurable","writable","value","g","AICompletionProvider","constructor","options","__publicField","this","aiService","contextAnalyzer","ContextAnalyzer","triggerCharacters","debounceDelay","maxSuggestions","enableInlineCompletion","register","monaco","language","languages","registerCompletionItemProvider","provideCompletionItems","async","model","position","_context","token","Promise","resolve","debounceTimer","clearTimeout","setTimeout","isCancellationRequested","suggestions","context","analyzeContext","monacoSuggestions","getAICompletions","map","item","label","displayText","text","kind","mapKind","insertText","documentation","sortText","score","range","startLineNumber","lineNumber","startColumn","column","endLineNumber","endColumn","error","registerInlineCompletion","registerInlineCompletionsProvider","provideInlineCompletions","items","getCompletion","prompt","beforeCursor","buildContextString","completion","freeInlineCompletions","response","maxTokens","split","inferKind","confidence","alternatives","forEach","alt","index","push","slice","contextStr","imports","length","join","functions","variables","includes","globalThis","method","CompletionItemKind","Method","function","Function","property","Property","variable","Variable","class","Class","snippet","Snippet","Text","dispose"],"mappings":"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"}