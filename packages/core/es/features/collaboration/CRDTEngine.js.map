{"version":3,"file":"CRDTEngine.js","sources":["../../../src/features/collaboration/CRDTEngine.ts"],"sourcesContent":["/**\n * CRDT (Conflict-free Replicated Data Type) 引擎\n * 实现无冲突的协同编辑\n */\n\nimport type { CRDTOperation, CRDTDocument, EditOperation } from '../../types/collaboration'\n\n/**\n * CRDT 引擎类\n * 基于 WOOT (WithOut Operational Transformation) 算法\n */\nexport class CRDTEngine {\n  private document: CRDTDocument\n  private userId: string\n  private lamportClock = 0\n\n  constructor(userId: string, initialContent = '') {\n    this.userId = userId\n    this.document = {\n      operations: [],\n      content: initialContent,\n      version: 0,\n    }\n  }\n\n  /**\n   * 本地插入操作\n   */\n  insert(position: number, content: string): CRDTOperation {\n    this.lamportClock++\n\n    const operation: CRDTOperation = {\n      id: this.generateId(),\n      type: 'insert',\n      position,\n      content,\n      timestamp: Date.now(),\n      userId: this.userId,\n      lamportClock: this.lamportClock,\n    }\n\n    this.applyOperation(operation)\n    return operation\n  }\n\n  /**\n   * 本地删除操作\n   */\n  delete(position: number, length: number): CRDTOperation {\n    this.lamportClock++\n\n    const operation: CRDTOperation = {\n      id: this.generateId(),\n      type: 'delete',\n      position,\n      length,\n      timestamp: Date.now(),\n      userId: this.userId,\n      lamportClock: this.lamportClock,\n    }\n\n    this.applyOperation(operation)\n    return operation\n  }\n\n  /**\n   * 应用远程操作\n   */\n  applyRemoteOperation(operation: CRDTOperation): void {\n    // 更新 Lamport 时钟\n    this.lamportClock = Math.max(this.lamportClock, operation.lamportClock) + 1\n\n    // 转换操作以处理并发\n    const transformedOperation = this.transformOperation(operation)\n\n    // 应用操作\n    this.applyOperation(transformedOperation)\n  }\n\n  /**\n   * 应用操作\n   */\n  private applyOperation(operation: CRDTOperation): void {\n    this.document.operations.push(operation)\n\n    if (operation.type === 'insert' && operation.content) {\n      const before = this.document.content.substring(0, operation.position)\n      const after = this.document.content.substring(operation.position)\n      this.document.content = before + operation.content + after\n    } else if (operation.type === 'delete' && operation.length) {\n      const before = this.document.content.substring(0, operation.position)\n      const after = this.document.content.substring(operation.position + operation.length)\n      this.document.content = before + after\n    }\n\n    this.document.version++\n  }\n\n  /**\n   * 操作转换（处理并发操作）\n   */\n  private transformOperation(operation: CRDTOperation): CRDTOperation {\n    let transformedPosition = operation.position\n\n    // 根据之前的操作调整位置\n    for (const op of this.document.operations) {\n      if (op.lamportClock < operation.lamportClock) {\n        if (op.type === 'insert' && op.position <= transformedPosition) {\n          transformedPosition += op.content?.length || 0\n        } else if (op.type === 'delete' && op.position < transformedPosition) {\n          transformedPosition -= Math.min(op.length || 0, transformedPosition - op.position)\n        }\n      }\n    }\n\n    return {\n      ...operation,\n      position: transformedPosition,\n    }\n  }\n\n  /**\n   * 生成唯一 ID\n   */\n  private generateId(): string {\n    return `${this.userId}-${this.lamportClock}-${Date.now()}`\n  }\n\n  /**\n   * 获取文档内容\n   */\n  getContent(): string {\n    return this.document.content\n  }\n\n  /**\n   * 获取文档版本\n   */\n  getVersion(): number {\n    return this.document.version\n  }\n\n  /**\n   * 获取所有操作\n   */\n  getOperations(): CRDTOperation[] {\n    return [...this.document.operations]\n  }\n\n  /**\n   * 重置文档\n   */\n  reset(content = ''): void {\n    this.document = {\n      operations: [],\n      content,\n      version: 0,\n    }\n    this.lamportClock = 0\n  }\n\n  /**\n   * 同步文档状态\n   */\n  sync(remoteDocument: CRDTDocument): void {\n    // 找出需要应用的操作\n    const localOps = new Set(this.document.operations.map((op) => op.id))\n    const missingOps = remoteDocument.operations.filter((op) => !localOps.has(op.id))\n\n    // 按 Lamport 时钟排序\n    missingOps.sort((a, b) => a.lamportClock - b.lamportClock)\n\n    // 应用缺失的操作\n    for (const op of missingOps) {\n      this.applyRemoteOperation(op)\n    }\n  }\n\n  /**\n   * 创建快照\n   */\n  createSnapshot(): CRDTDocument {\n    return {\n      operations: [...this.document.operations],\n      content: this.document.content,\n      version: this.document.version,\n    }\n  }\n\n  /**\n   * 从快照恢复\n   */\n  restoreFromSnapshot(snapshot: CRDTDocument): void {\n    this.document = {\n      operations: [...snapshot.operations],\n      content: snapshot.content,\n      version: snapshot.version,\n    }\n\n    // 更新 Lamport 时钟\n    if (snapshot.operations.length > 0) {\n      this.lamportClock = Math.max(...snapshot.operations.map((op) => op.lamportClock))\n    }\n  }\n\n  /**\n   * 转换为编辑器操作\n   */\n  toEditorOperation(operation: CRDTOperation): EditOperation {\n    return {\n      type: operation.type === 'insert' ? 'insert' : 'delete',\n      position: {\n        line: this.offsetToPosition(operation.position).line,\n        column: this.offsetToPosition(operation.position).column,\n      },\n      content: operation.content || '',\n      length: operation.length,\n      version: this.document.version,\n      userId: operation.userId,\n      timestamp: operation.timestamp,\n    }\n  }\n\n  /**\n   * 从编辑器操作转换\n   */\n  fromEditorOperation(operation: EditOperation): CRDTOperation {\n    this.lamportClock++\n\n    return {\n      id: this.generateId(),\n      type: operation.type === 'insert' ? 'insert' : 'delete',\n      position: this.positionToOffset(operation.position),\n      content: operation.content,\n      length: operation.length,\n      timestamp: operation.timestamp,\n      userId: operation.userId,\n      lamportClock: this.lamportClock,\n    }\n  }\n\n  /**\n   * 位置转偏移量\n   */\n  private positionToOffset(position: { line: number; column: number }): number {\n    const lines = this.document.content.split('\\n')\n    let offset = 0\n\n    for (let i = 0; i < position.line && i < lines.length; i++) {\n      offset += lines[i].length + 1 // +1 for newline\n    }\n\n    offset += position.column\n    return offset\n  }\n\n  /**\n   * 偏移量转位置\n   */\n  private offsetToPosition(offset: number): { line: number; column: number } {\n    const lines = this.document.content.split('\\n')\n    let currentOffset = 0\n\n    for (let line = 0; line < lines.length; line++) {\n      const lineLength = lines[line].length + 1 // +1 for newline\n\n      if (currentOffset + lineLength > offset) {\n        return {\n          line,\n          column: offset - currentOffset,\n        }\n      }\n\n      currentOffset += lineLength\n    }\n\n    return {\n      line: lines.length - 1,\n      column: lines[lines.length - 1]?.length || 0,\n    }\n  }\n}\n\n"],"names":["l","Object","defineProperty","r","i","t","e","enumerable","configurable","writable","value","p","CRDTEngine","constructor","userId","initialContent","__publicField","this","document","operations","content","version","insert","position","lamportClock","operation","id","generateId","type","timestamp","Date","now","applyOperation","length","applyRemoteOperation","Math","max","transformedOperation","transformOperation","push","before","substring","after","transformedPosition","op","min","getContent","getVersion","getOperations","reset","sync","remoteDocument","localOps","Set","map","missingOps","filter","has","sort","a","b","createSnapshot","restoreFromSnapshot","snapshot","toEditorOperation","line","offsetToPosition","column","fromEditorOperation","positionToOffset","lines","split","offset","currentOffset","lineLength"],"mappings":"AAWO,IAAAA,EAAAC,OAAAC,eAAAC,EAAA,CAAAC,EAAAC,EAAAC,KAAA,EAAAF,EAAAC,EAAAC,KAAAD,KAAAD,EAAAJ,EAAAI,EAAAC,EAAA,CAAAE,YAAA,EAAAC,cAAA,EAAAC,UAAA,EAAAC,MAAAJ,IAAAF,EAAAC,GAAAC,GAAAK,CAAAP,EAAA,iBAAAC,EAAAA,EAAA,GAAAA,EAAAC,GAAAA,GAAA,MAAMM,EAKX,WAAAC,CAAYC,EAAgBC,EAAiB,IAJ7CC,EAAAC,KAAQ,YACRD,EAAAC,KAAQ,UACRD,EAAAC,KAAQ,eAAe,GAGrBA,KAAKH,OAASA,EACdG,KAAKC,SAAW,CACdC,WAAY,GACZC,QAASL,EACTM,QAAS,EAEb,CAKA,MAAAC,CAAOC,EAAkBH,GACvBH,KAAKO,eAEL,MAAMC,EAA2B,CAC/BC,GAAIT,KAAKU,aACTC,KAAM,SACNL,SAAAA,EACAH,QAAAA,EACAS,UAAWC,KAAKC,MAChBjB,OAAQG,KAAKH,OACbU,aAAcP,KAAKO,cAGrB,OAAAP,KAAKe,eAAeP,GACbA,CACT,CAKA,OAAOF,EAAkBU,GACvBhB,KAAKO,eAEL,MAAMC,EAA2B,CAC/BC,GAAIT,KAAKU,aACTC,KAAM,SACNL,SAAAA,EACAU,OAAAA,EACAJ,UAAWC,KAAKC,MAChBjB,OAAQG,KAAKH,OACbU,aAAcP,KAAKO,cAGrB,OAAAP,KAAKe,eAAeP,GACbA,CACT,CAKA,oBAAAS,CAAqBT,GAEnBR,KAAKO,aAAeW,KAAKC,IAAInB,KAAKO,aAAcC,EAAUD,cAAgB,EAG1E,MAAMa,EAAuBpB,KAAKqB,mBAAmBb,GAGrDR,KAAKe,eAAeK,EACtB,CAKQ,cAAAL,CAAeP,GAGrB,GAFAR,KAAKC,SAASC,WAAWoB,KAAKd,GAEP,WAAnBA,EAAUG,MAAqBH,EAAUL,QAAS,CACpD,MAAMoB,EAASvB,KAAKC,SAASE,QAAQqB,UAAU,EAAGhB,EAAUF,UACtDmB,EAAQzB,KAAKC,SAASE,QAAQqB,UAAUhB,EAAUF,UACxDN,KAAKC,SAASE,QAAUoB,EAASf,EAAUL,QAAUsB,CACvD,MAAA,GAA8B,WAAnBjB,EAAUG,MAAqBH,EAAUQ,OAAQ,CAC1D,MAAMO,EAASvB,KAAKC,SAASE,QAAQqB,UAAU,EAAGhB,EAAUF,UACtDmB,EAAQzB,KAAKC,SAASE,QAAQqB,UAAUhB,EAAUF,SAAWE,EAAUQ,QAC7EhB,KAAKC,SAASE,QAAUoB,EAASE,CACnC,CAEAzB,KAAKC,SAASG,SAChB,CAKQ,kBAAAiB,CAAmBb,GACzB,IAAIkB,EAAsBlB,EAAUF,SAGpC,IAAA,MAAWqB,KAAM3B,KAAKC,SAASC,WACzByB,EAAGpB,aAAeC,EAAUD,eACd,WAAZoB,EAAGhB,MAAqBgB,EAAGrB,UAAYoB,EACzCA,GAAuBC,EAAGxB,SAASa,QAAU,EACxB,WAAZW,EAAGhB,MAAqBgB,EAAGrB,SAAWoB,IAC/CA,GAAuBR,KAAKU,IAAID,EAAGX,QAAU,EAAGU,EAAsBC,EAAGrB,YAK/E,MAAO,IACFE,EACHF,SAAUoB,EAEd,CAKQ,UAAAhB,GACN,MAAO,GAAGV,KAAKH,UAAUG,KAAKO,gBAAgBM,KAAKC,OACrD,CAKA,UAAAe,GACE,OAAO7B,KAAKC,SAASE,OACvB,CAKA,UAAA2B,GACE,OAAO9B,KAAKC,SAASG,OACvB,CAKA,aAAA2B,GACE,MAAO,IAAI/B,KAAKC,SAASC,WAC3B,CAKA,KAAA8B,CAAM7B,EAAU,IACdH,KAAKC,SAAW,CACdC,WAAY,GACZC,QAAAA,EACAC,QAAS,GAEXJ,KAAKO,aAAe,CACtB,CAKA,IAAA0B,CAAKC,GAEH,MAAMC,EAAW,IAAIC,IAAIpC,KAAKC,SAASC,WAAWmC,IAAKV,GAAOA,EAAGlB,KAC3D6B,EAAaJ,EAAehC,WAAWqC,OAAQZ,IAAQQ,EAASK,IAAIb,EAAGlB,KAG7E6B,EAAWG,KAAK,CAACC,EAAGC,IAAMD,EAAEnC,aAAeoC,EAAEpC,cAG7C,IAAA,MAAWoB,KAAMW,EACftC,KAAKiB,qBAAqBU,EAE9B,CAKA,cAAAiB,GACE,MAAO,CACL1C,WAAY,IAAIF,KAAKC,SAASC,YAC9BC,QAASH,KAAKC,SAASE,QACvBC,QAASJ,KAAKC,SAASG,QAE3B,CAKA,mBAAAyC,CAAoBC,GAClB9C,KAAKC,SAAW,CACdC,WAAY,IAAI4C,EAAS5C,YACzBC,QAAS2C,EAAS3C,QAClBC,QAAS0C,EAAS1C,SAIhB0C,EAAS5C,WAAWc,OAAS,IAC/BhB,KAAKO,aAAeW,KAAKC,OAAO2B,EAAS5C,WAAWmC,IAAKV,GAAOA,EAAGpB,eAEvE,CAKA,iBAAAwC,CAAkBvC,GAChB,MAAO,CACLG,KAAyB,WAAnBH,EAAUG,KAAoB,SAAW,SAC/CL,SAAU,CACR0C,KAAMhD,KAAKiD,iBAAiBzC,EAAUF,UAAU0C,KAChDE,OAAQlD,KAAKiD,iBAAiBzC,EAAUF,UAAU4C,QAEpD/C,QAASK,EAAUL,SAAW,GAC9Ba,OAAQR,EAAUQ,OAClBZ,QAASJ,KAAKC,SAASG,QACvBP,OAAQW,EAAUX,OAClBe,UAAWJ,EAAUI,UAEzB,CAKA,mBAAAuC,CAAoB3C,GAClB,OAAAR,KAAKO,eAEE,CACLE,GAAIT,KAAKU,aACTC,KAAyB,WAAnBH,EAAUG,KAAoB,SAAW,SAC/CL,SAAUN,KAAKoD,iBAAiB5C,EAAUF,UAC1CH,QAASK,EAAUL,QACnBa,OAAQR,EAAUQ,OAClBJ,UAAWJ,EAAUI,UACrBf,OAAQW,EAAUX,OAClBU,aAAcP,KAAKO,aAEvB,CAKQ,gBAAA6C,CAAiB9C,GACvB,MAAM+C,EAAQrD,KAAKC,SAASE,QAAQmD,MAAM,MAC1C,IAAIC,EAAS,EAEb,QAASpE,EAAI,EAAGA,EAAImB,EAAS0C,MAAQ7D,EAAIkE,EAAMrC,OAAQ7B,IACrDoE,GAAUF,EAAMlE,GAAG6B,OAAS,EAG9B,OAAAuC,GAAUjD,EAAS4C,OACZK,CACT,CAKQ,gBAAAN,CAAiBM,GACvB,MAAMF,EAAQrD,KAAKC,SAASE,QAAQmD,MAAM,MAC1C,IAAIE,EAAgB,EAEpB,QAASR,EAAO,EAAGA,EAAOK,EAAMrC,OAAQgC,IAAQ,CAC9C,MAAMS,EAAaJ,EAAML,GAAMhC,OAAS,EAExC,GAAIwC,EAAgBC,EAAaF,EAC/B,MAAO,CACLP,KAAAA,EACAE,OAAQK,EAASC,GAIrBA,GAAiBC,CACnB,CAEA,MAAO,CACLT,KAAMK,EAAMrC,OAAS,EACrBkC,OAAQG,EAAMA,EAAMrC,OAAS,IAAIA,QAAU,EAE/C"}