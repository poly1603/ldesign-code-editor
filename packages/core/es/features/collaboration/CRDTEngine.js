var t=Object.defineProperty,o=(o,e,n)=>(((o,e,n)=>{e in o?t(o,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[e]=n})(o,"symbol"!=typeof e?e+"":e,n),n);class e{constructor(t,e=""){o(this,"document"),o(this,"userId"),o(this,"lamportClock",0),this.userId=t,this.document={operations:[],content:e,version:0}}insert(t,o){this.lamportClock++;const e={id:this.generateId(),type:"insert",position:t,content:o,timestamp:Date.now(),userId:this.userId,lamportClock:this.lamportClock};return this.applyOperation(e),e}delete(t,o){this.lamportClock++;const e={id:this.generateId(),type:"delete",position:t,length:o,timestamp:Date.now(),userId:this.userId,lamportClock:this.lamportClock};return this.applyOperation(e),e}applyRemoteOperation(t){this.lamportClock=Math.max(this.lamportClock,t.lamportClock)+1;const o=this.transformOperation(t);this.applyOperation(o)}applyOperation(t){if(this.document.operations.push(t),"insert"===t.type&&t.content){const o=this.document.content.substring(0,t.position),e=this.document.content.substring(t.position);this.document.content=o+t.content+e}else if("delete"===t.type&&t.length){const o=this.document.content.substring(0,t.position),e=this.document.content.substring(t.position+t.length);this.document.content=o+e}this.document.version++}transformOperation(t){let o=t.position;for(const e of this.document.operations)e.lamportClock<t.lamportClock&&("insert"===e.type&&e.position<=o?o+=e.content?.length||0:"delete"===e.type&&e.position<o&&(o-=Math.min(e.length||0,o-e.position)));return{...t,position:o}}generateId(){return`${this.userId}-${this.lamportClock}-${Date.now()}`}getContent(){return this.document.content}getVersion(){return this.document.version}getOperations(){return[...this.document.operations]}reset(t=""){this.document={operations:[],content:t,version:0},this.lamportClock=0}sync(t){const o=new Set(this.document.operations.map(t=>t.id)),e=t.operations.filter(t=>!o.has(t.id));e.sort((t,o)=>t.lamportClock-o.lamportClock);for(const t of e)this.applyRemoteOperation(t)}createSnapshot(){return{operations:[...this.document.operations],content:this.document.content,version:this.document.version}}restoreFromSnapshot(t){this.document={operations:[...t.operations],content:t.content,version:t.version},t.operations.length>0&&(this.lamportClock=Math.max(...t.operations.map(t=>t.lamportClock)))}toEditorOperation(t){return{type:"insert"===t.type?"insert":"delete",position:{line:this.offsetToPosition(t.position).line,column:this.offsetToPosition(t.position).column},content:t.content||"",length:t.length,version:this.document.version,userId:t.userId,timestamp:t.timestamp}}fromEditorOperation(t){return this.lamportClock++,{id:this.generateId(),type:"insert"===t.type?"insert":"delete",position:this.positionToOffset(t.position),content:t.content,length:t.length,timestamp:t.timestamp,userId:t.userId,lamportClock:this.lamportClock}}positionToOffset(t){const o=this.document.content.split("\n");let e=0;for(let n=0;n<t.line&&n<o.length;n++)e+=o[n].length+1;return e+=t.column,e}offsetToPosition(t){const o=this.document.content.split("\n");let e=0;for(let n=0;n<o.length;n++){const i=o[n].length+1;if(e+i>t)return{line:n,column:t-e};e+=i}return{line:o.length-1,column:o[o.length-1]?.length||0}}}export{e as CRDTEngine};
//# sourceMappingURL=CRDTEngine.js.map
