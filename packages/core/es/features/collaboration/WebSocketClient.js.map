{"version":3,"file":"WebSocketClient.js","sources":["../../../src/features/collaboration/WebSocketClient.ts"],"sourcesContent":["/**\n * WebSocket 客户端\n * 处理实时通信\n */\n\nimport type { CollaborationMessage } from '../../types/collaboration'\n\nexport interface WebSocketClientOptions {\n  url: string\n  reconnectAttempts?: number\n  reconnectDelay?: number\n  heartbeatInterval?: number\n  onOpen?: () => void\n  onClose?: () => void\n  onError?: (error: Error) => void\n  onMessage?: (message: CollaborationMessage) => void\n}\n\nexport class WebSocketClient {\n  private ws: WebSocket | null = null\n  private options: Required<WebSocketClientOptions>\n  private reconnectAttempts = 0\n  private heartbeatTimer: ReturnType<typeof setInterval> | null = null\n  private isIntentionallyClosed = false\n  private messageQueue: CollaborationMessage[] = []\n\n  constructor(options: WebSocketClientOptions) {\n    this.options = {\n      url: options.url,\n      reconnectAttempts: options.reconnectAttempts || 5,\n      reconnectDelay: options.reconnectDelay || 3000,\n      heartbeatInterval: options.heartbeatInterval || 30000,\n      onOpen: options.onOpen || (() => { }),\n      onClose: options.onClose || (() => { }),\n      onError: options.onError || (() => { }),\n      onMessage: options.onMessage || (() => { }),\n    }\n  }\n\n  /**\n   * 连接到服务器\n   */\n  connect(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      try {\n        this.ws = new WebSocket(this.options.url)\n\n        this.ws.onopen = () => {\n          console.log('WebSocket connected')\n          this.reconnectAttempts = 0\n          this.startHeartbeat()\n          this.flushMessageQueue()\n          this.options.onOpen()\n          resolve()\n        }\n\n        this.ws.onclose = (event) => {\n          console.log('WebSocket closed', event.code, event.reason)\n          this.stopHeartbeat()\n          this.options.onClose()\n\n          if (!this.isIntentionallyClosed) {\n            this.attemptReconnect()\n          }\n        }\n\n        this.ws.onerror = (event) => {\n          console.error('WebSocket error:', event)\n          const error = new Error('WebSocket connection error')\n          this.options.onError(error)\n          reject(error)\n        }\n\n        this.ws.onmessage = (event) => {\n          try {\n            const message: CollaborationMessage = JSON.parse(event.data)\n            this.options.onMessage(message)\n          } catch (error) {\n            console.error('Failed to parse message:', error)\n          }\n        }\n      } catch (error) {\n        reject(error)\n      }\n    })\n  }\n\n  /**\n   * 发送消息\n   */\n  send(message: CollaborationMessage): void {\n    if (this.isConnected()) {\n      this.ws!.send(JSON.stringify(message))\n    } else {\n      // 排队等待重连\n      this.messageQueue.push(message)\n    }\n  }\n\n  /**\n   * 检查连接状态\n   */\n  isConnected(): boolean {\n    return this.ws !== null && this.ws.readyState === WebSocket.OPEN\n  }\n\n  /**\n   * 关闭连接\n   */\n  close(): void {\n    this.isIntentionallyClosed = true\n    this.stopHeartbeat()\n\n    if (this.ws) {\n      this.ws.close(1000, 'Client closed connection')\n      this.ws = null\n    }\n  }\n\n  /**\n   * 尝试重连\n   */\n  private attemptReconnect(): void {\n    if (this.reconnectAttempts >= this.options.reconnectAttempts) {\n      console.error('Max reconnection attempts reached')\n      return\n    }\n\n    this.reconnectAttempts++\n    console.log(`Reconnecting... Attempt ${this.reconnectAttempts}`)\n\n    setTimeout(() => {\n      this.connect().catch((error) => {\n        console.error('Reconnection failed:', error)\n      })\n    }, this.options.reconnectDelay * this.reconnectAttempts)\n  }\n\n  /**\n   * 开始心跳\n   */\n  private startHeartbeat(): void {\n    this.heartbeatTimer = setInterval(() => {\n      if (this.isConnected()) {\n        this.send({\n          type: 'presence',\n          senderId: '',\n          timestamp: Date.now(),\n          data: { type: 'heartbeat' },\n        })\n      }\n    }, this.options.heartbeatInterval)\n  }\n\n  /**\n   * 停止心跳\n   */\n  private stopHeartbeat(): void {\n    if (this.heartbeatTimer) {\n      clearInterval(this.heartbeatTimer)\n      this.heartbeatTimer = null\n    }\n  }\n\n  /**\n   * 刷新消息队列\n   */\n  private flushMessageQueue(): void {\n    while (this.messageQueue.length > 0) {\n      const message = this.messageQueue.shift()\n      if (message) {\n        this.send(message)\n      }\n    }\n  }\n\n  /**\n   * 获取连接状态\n   */\n  getReadyState(): number {\n    return this.ws?.readyState || WebSocket.CLOSED\n  }\n\n  /**\n   * 获取队列大小\n   */\n  getQueueSize(): number {\n    return this.messageQueue.length\n  }\n}\n\n"],"names":["WebSocketClient","constructor","options","__publicField","this","url","reconnectAttempts","reconnectDelay","heartbeatInterval","onOpen","onClose","onError","onMessage","connect","Promise","resolve","reject","ws","WebSocket","onopen","startHeartbeat","flushMessageQueue","onclose","event","stopHeartbeat","isIntentionallyClosed","attemptReconnect","onerror","error","Error","onmessage","message","JSON","parse","data","send","isConnected","stringify","messageQueue","push","readyState","OPEN","close","setTimeout","catch","heartbeatTimer","setInterval","type","senderId","timestamp","Date","now","clearInterval","length","shift","getReadyState","CLOSED","getQueueSize"],"mappings":"gKAkBO,MAAMA,EAQX,WAAAC,CAAYC,GAPZC,EAAAC,KAAQ,KAAuB,MAC/BD,EAAAC,KAAQ,WACRD,EAAAC,KAAQ,oBAAoB,GAC5BD,EAAAC,KAAQ,iBAAwD,MAChED,EAAAC,KAAQ,yBAAwB,GAChCD,EAAAC,KAAQ,eAAuC,IAG7CA,KAAKF,QAAU,CACbG,IAAKH,EAAQG,IACbC,kBAAmBJ,EAAQI,mBAAqB,EAChDC,eAAgBL,EAAQK,gBAAkB,IAC1CC,kBAAmBN,EAAQM,mBAAqB,IAChDC,OAAQP,EAAQO,QAAA,MAAmB,GACnCC,QAASR,EAAQQ,SAAA,MAAoB,GACrCC,QAAST,EAAQS,SAAA,SACjBC,UAAWV,EAAQU,WAAA,MAAsB,GAE7C,CAKA,OAAAC,GACE,OAAO,IAAIC,QAAQ,CAACC,EAASC,KAC3B,IACEZ,KAAKa,GAAK,IAAIC,UAAUd,KAAKF,QAAQG,KAErCD,KAAKa,GAAGE,OAAS,KAEff,KAAKE,kBAAoB,EACzBF,KAAKgB,iBACLhB,KAAKiB,oBACLjB,KAAKF,QAAQO,SACbM,KAGFX,KAAKa,GAAGK,QAAWC,IAEjBnB,KAAKoB,gBACLpB,KAAKF,QAAQQ,UAERN,KAAKqB,uBACRrB,KAAKsB,oBAITtB,KAAKa,GAAGU,QAAWJ,IAEjB,MAAMK,EAAQ,IAAIC,MAAM,8BACxBzB,KAAKF,QAAQS,QAAQiB,GACrBZ,EAAOY,IAGTxB,KAAKa,GAAGa,UAAaP,IACnB,IACE,MAAMQ,EAAgCC,KAAKC,MAAMV,EAAMW,MACvD9B,KAAKF,QAAQU,UAAUmB,EACzB,CAAA,MAASH,GAET,EAEJ,CAAA,MAASA,GACPZ,EAAOY,EACT,GAEJ,CAKA,IAAAO,CAAKJ,GACC3B,KAAKgC,cACPhC,KAAKa,GAAIkB,KAAKH,KAAKK,UAAUN,IAG7B3B,KAAKkC,aAAaC,KAAKR,EAE3B,CAKA,WAAAK,GACE,OAAmB,OAAZhC,KAAKa,IAAeb,KAAKa,GAAGuB,aAAetB,UAAUuB,IAC9D,CAKA,KAAAC,GACEtC,KAAKqB,uBAAwB,EAC7BrB,KAAKoB,gBAEDpB,KAAKa,KACPb,KAAKa,GAAGyB,MAAM,IAAM,4BACpBtC,KAAKa,GAAK,KAEd,CAKQ,gBAAAS,GACFtB,KAAKE,mBAAqBF,KAAKF,QAAQI,oBAK3CF,KAAKE,oBAGLqC,WAAW,KACTvC,KAAKS,UAAU+B,MAAOhB,QAGrBxB,KAAKF,QAAQK,eAAiBH,KAAKE,mBACxC,CAKQ,cAAAc,GACNhB,KAAKyC,eAAiBC,YAAY,KAC5B1C,KAAKgC,eACPhC,KAAK+B,KAAK,CACRY,KAAM,WACNC,SAAU,GACVC,UAAWC,KAAKC,MAChBjB,KAAM,CAAEa,KAAM,gBAGjB3C,KAAKF,QAAQM,kBAClB,CAKQ,aAAAgB,GACFpB,KAAKyC,iBACPO,cAAchD,KAAKyC,gBACnBzC,KAAKyC,eAAiB,KAE1B,CAKQ,iBAAAxB,GACN,KAAOjB,KAAKkC,aAAae,OAAS,GAAG,CACnC,MAAMtB,EAAU3B,KAAKkC,aAAagB,QAC9BvB,GACF3B,KAAK+B,KAAKJ,EAEd,CACF,CAKA,aAAAwB,GACE,OAAOnD,KAAKa,IAAIuB,YAActB,UAAUsC,MAC1C,CAKA,YAAAC,GACE,OAAOrD,KAAKkC,aAAae,MAC3B"}