{"version":3,"file":"CollaborationManager.js","sources":["../../../src/features/collaboration/CollaborationManager.ts"],"sourcesContent":["/**\n * 协同编辑管理器\n */\n\nimport { WebSocketClient } from './WebSocketClient'\nimport { CRDTEngine } from './CRDTEngine'\nimport { UserPresenceManager } from './UserPresence'\nimport type {\n  CollaborationConfig,\n  CollaborationMessage,\n  CollaborationEvents,\n  EditOperation,\n} from '../../types/collaboration'\n\nexport class CollaborationManager {\n  private wsClient: WebSocketClient\n  private crdt: CRDTEngine\n  private presence: UserPresenceManager\n  private config: CollaborationConfig\n  private events: CollaborationEvents\n\n  constructor(config: CollaborationConfig, events: CollaborationEvents = {}) {\n    this.config = config\n    this.events = events\n\n    this.crdt = new CRDTEngine(config.user.id, '')\n    this.presence = new UserPresenceManager(config.user.id)\n\n    this.wsClient = new WebSocketClient({\n      url: config.serverUrl,\n      onOpen: () => this.handleConnect(),\n      onClose: () => this.handleDisconnect(),\n      onError: (error) => events.onError?.(error),\n      onMessage: (msg) => this.handleMessage(msg),\n    })\n\n    if (config.autoConnect !== false) {\n      this.connect()\n    }\n  }\n\n  async connect(): Promise<void> {\n    await this.wsClient.connect()\n  }\n\n  disconnect(): void {\n    this.wsClient.close()\n  }\n\n  sendEdit(operation: EditOperation): void {\n    const crdtOp = this.crdt.fromEditorOperation(operation)\n    this.wsClient.send({\n      type: 'edit',\n      senderId: this.config.user.id,\n      timestamp: Date.now(),\n      data: crdtOp,\n    })\n  }\n\n  private handleConnect(): void {\n    this.wsClient.send({\n      type: 'join',\n      senderId: this.config.user.id,\n      timestamp: Date.now(),\n      data: { user: this.config.user, roomId: this.config.roomId },\n    })\n  }\n\n  private handleDisconnect(): void {\n    this.events.onUserLeft?.(this.config.user.id)\n  }\n\n  private handleMessage(message: CollaborationMessage): void {\n    switch (message.type) {\n      case 'join':\n        this.presence.addUser(message.data as any)\n        this.events.onUserJoined?.(message.data as any)\n        break\n      case 'leave':\n        this.presence.removeUser(message.senderId)\n        this.events.onUserLeft?.(message.senderId)\n        break\n      case 'edit':\n        this.crdt.applyRemoteOperation(message.data as any)\n        this.events.onEdit?.(this.crdt.toEditorOperation(message.data as any))\n        break\n      case 'cursor':\n        this.presence.updateCursor(message.senderId, message.data as any)\n        this.events.onCursorChange?.(message.senderId, message.data as any)\n        break\n    }\n  }\n\n  dispose(): void {\n    this.disconnect()\n  }\n}\n\n"],"names":["s","Object","defineProperty","i","n","e","t","enumerable","configurable","writable","value","r","CollaborationManager","constructor","config","events","__publicField","this","crdt","CRDTEngine","user","id","presence","UserPresenceManager","wsClient","WebSocketClient","url","serverUrl","onOpen","handleConnect","onClose","handleDisconnect","onError","error","onMessage","msg","handleMessage","autoConnect","connect","disconnect","close","sendEdit","operation","crdtOp","fromEditorOperation","send","type","senderId","timestamp","Date","now","data","roomId","onUserLeft","message","addUser","onUserJoined","removeUser","applyRemoteOperation","onEdit","toEditorOperation","updateCursor","onCursorChange","dispose"],"mappings":"4JAIA,IAAAA,EAAAC,OAAAC,eAAAC,EAAA,CAAAC,EAAAC,EAAAC,KAAA,EAAAF,EAAAC,EAAAC,KAAAD,KAAAD,EAAAJ,EAAAI,EAAAC,EAAA,CAAAE,YAAA,EAAAC,cAAA,EAAAC,UAAA,EAAAC,MAAAJ,IAAAF,EAAAC,GAAAC,GAAAK,CAAAP,EAAA,iBAAAC,EAAAA,EAAA,GAAAA,EAAAC,GAAAA,GAUO,MAAMM,EAOX,WAAAC,CAAYC,EAA6BC,EAA8B,CAAA,GANvEC,EAAAC,KAAQ,YACRD,EAAAC,KAAQ,QACRD,EAAAC,KAAQ,YACRD,EAAAC,KAAQ,UACRD,EAAAC,KAAQ,UAGNA,KAAKH,OAASA,EACdG,KAAKF,OAASA,EAEdE,KAAKC,KAAO,IAAIC,EAAWL,EAAOM,KAAKC,GAAI,IAC3CJ,KAAKK,SAAW,IAAIC,EAAoBT,EAAOM,KAAKC,IAEpDJ,KAAKO,SAAW,IAAIC,EAAgB,CAClCC,IAAKZ,EAAOa,UACZC,OAAQ,IAAMX,KAAKY,gBACnBC,QAAS,IAAMb,KAAKc,mBACpBC,QAAUC,GAAUlB,EAAOiB,UAAUC,GACrCC,UAAYC,GAAQlB,KAAKmB,cAAcD,MAGd,IAAvBrB,EAAOuB,aACTpB,KAAKqB,SAET,CAEA,aAAMA,SACErB,KAAKO,SAASc,SACtB,CAEA,UAAAC,GACEtB,KAAKO,SAASgB,OAChB,CAEA,QAAAC,CAASC,GACP,MAAMC,EAAS1B,KAAKC,KAAK0B,oBAAoBF,GAC7CzB,KAAKO,SAASqB,KAAK,CACjBC,KAAM,OACNC,SAAU9B,KAAKH,OAAOM,KAAKC,GAC3B2B,UAAWC,KAAKC,MAChBC,KAAMR,GAEV,CAEQ,aAAAd,GACNZ,KAAKO,SAASqB,KAAK,CACjBC,KAAM,OACNC,SAAU9B,KAAKH,OAAOM,KAAKC,GAC3B2B,UAAWC,KAAKC,MAChBC,KAAM,CAAE/B,KAAMH,KAAKH,OAAOM,KAAMgC,OAAQnC,KAAKH,OAAOsC,SAExD,CAEQ,gBAAArB,GACNd,KAAKF,OAAOsC,aAAapC,KAAKH,OAAOM,KAAKC,GAC5C,CAEQ,aAAAe,CAAckB,GACpB,OAAQA,EAAQR,MACd,IAAK,OACH7B,KAAKK,SAASiC,QAAQD,EAAQH,MAC9BlC,KAAKF,OAAOyC,eAAeF,EAAQH,MACnC,MACF,IAAK,QACHlC,KAAKK,SAASmC,WAAWH,EAAQP,UACjC9B,KAAKF,OAAOsC,aAAaC,EAAQP,UACjC,MACF,IAAK,OACH9B,KAAKC,KAAKwC,qBAAqBJ,EAAQH,MACvClC,KAAKF,OAAO4C,SAAS1C,KAAKC,KAAK0C,kBAAkBN,EAAQH,OACzD,MACF,IAAK,SACHlC,KAAKK,SAASuC,aAAaP,EAAQP,SAAUO,EAAQH,MACrDlC,KAAKF,OAAO+C,iBAAiBR,EAAQP,SAAUO,EAAQH,MAG7D,CAEA,OAAAY,GACE9C,KAAKsB,YACP"}