{"version":3,"file":"EditorPool.js","sources":["../../src/core/EditorPool.ts"],"sourcesContent":["/**\n * 编辑器实例池\n * 复用编辑器实例以优化性能和内存\n */\n\nimport type * as Monaco from 'monaco-editor'\nimport type { CodeEditor } from './CodeEditor'\n\nexport interface PoolOptions {\n  minSize?: number\n  maxSize?: number\n  maxIdleTime?: number\n  warmup?: boolean\n}\n\nexport interface PoolStats {\n  total: number\n  active: number\n  idle: number\n  created: number\n  reused: number\n  destroyed: number\n}\n\n/**\n * 编辑器池项\n */\ninterface PoolItem {\n  editor: CodeEditor\n  inUse: boolean\n  lastUsed: number\n  created: number\n  usageCount: number\n}\n\n/**\n * 编辑器实例池类\n */\nexport class EditorPool {\n  private pool: PoolItem[] = []\n  private options: Required<PoolOptions>\n  private stats: PoolStats = {\n    total: 0,\n    active: 0,\n    idle: 0,\n    created: 0,\n    reused: 0,\n    destroyed: 0,\n  }\n  private cleanupInterval: ReturnType<typeof setInterval> | null = null\n  private editorFactory: (container: HTMLElement) => CodeEditor\n\n  constructor(\n    editorFactory: (container: HTMLElement) => CodeEditor,\n    options: PoolOptions = {}\n  ) {\n    this.editorFactory = editorFactory\n    this.options = {\n      minSize: options.minSize || 0,\n      maxSize: options.maxSize || 10,\n      maxIdleTime: options.maxIdleTime || 5 * 60 * 1000, // 5 minutes\n      warmup: options.warmup || false,\n    }\n\n    if (this.options.warmup) {\n      this.warmUp()\n    }\n\n    this.startCleanup()\n  }\n\n  /**\n   * 预热池\n   */\n  private warmUp(): void {\n    const count = this.options.minSize\n    for (let i = 0; i < count; i++) {\n      // 创建隐藏容器\n      const container = this.createHiddenContainer()\n      const editor = this.editorFactory(container)\n\n      this.pool.push({\n        editor,\n        inUse: false,\n        lastUsed: Date.now(),\n        created: Date.now(),\n        usageCount: 0,\n      })\n\n      this.stats.created++\n      this.stats.idle++\n    }\n\n    this.stats.total = this.pool.length\n  }\n\n  /**\n   * 创建隐藏容器\n   */\n  private createHiddenContainer(): HTMLElement {\n    const container = document.createElement('div')\n    container.style.position = 'absolute'\n    container.style.top = '-9999px'\n    container.style.left = '-9999px'\n    container.style.width = '800px'\n    container.style.height = '600px'\n    document.body.appendChild(container)\n    return container\n  }\n\n  /**\n   * 获取编辑器\n   */\n  acquire(container: HTMLElement): CodeEditor {\n    // 尝试从池中获取空闲编辑器\n    const idleItem = this.pool.find((item) => !item.inUse)\n\n    if (idleItem) {\n      idleItem.inUse = true\n      idleItem.lastUsed = Date.now()\n      idleItem.usageCount++\n\n      this.stats.active++\n      this.stats.idle--\n      this.stats.reused++\n\n      // TODO: 将编辑器移动到新容器\n      return idleItem.editor\n    }\n\n    // 如果池未满，创建新编辑器\n    if (this.pool.length < this.options.maxSize) {\n      const editor = this.editorFactory(container)\n\n      const item: PoolItem = {\n        editor,\n        inUse: true,\n        lastUsed: Date.now(),\n        created: Date.now(),\n        usageCount: 1,\n      }\n\n      this.pool.push(item)\n\n      this.stats.created++\n      this.stats.active++\n      this.stats.total++\n\n      return editor\n    }\n\n    // 池已满，强制创建新编辑器（不加入池）\n    console.warn('Editor pool is full, creating temporary editor')\n    return this.editorFactory(container)\n  }\n\n  /**\n   * 释放编辑器\n   */\n  release(editor: CodeEditor): void {\n    const item = this.pool.find((i) => i.editor === editor)\n\n    if (item && item.inUse) {\n      item.inUse = false\n      item.lastUsed = Date.now()\n\n      this.stats.active--\n      this.stats.idle++\n\n      // 清理编辑器状态\n      this.resetEditor(editor)\n    }\n  }\n\n  /**\n   * 重置编辑器状态\n   */\n  private resetEditor(editor: CodeEditor): void {\n    try {\n      editor.setValue('')\n      // 可以添加更多清理逻辑\n    } catch (error) {\n      console.error('Failed to reset editor:', error)\n    }\n  }\n\n  /**\n   * 开始清理任务\n   */\n  private startCleanup(): void {\n    this.cleanupInterval = setInterval(() => {\n      this.cleanup()\n    }, 60000) // 每分钟清理一次\n  }\n\n  /**\n   * 清理空闲编辑器\n   */\n  private cleanup(): void {\n    const now = Date.now()\n    const toRemove: number[] = []\n\n    // 找出需要清理的编辑器\n    this.pool.forEach((item, index) => {\n      if (\n        !item.inUse &&\n        now - item.lastUsed > this.options.maxIdleTime &&\n        this.pool.length > this.options.minSize\n      ) {\n        toRemove.push(index)\n      }\n    })\n\n    // 从后向前删除\n    toRemove.reverse().forEach((index) => {\n      const item = this.pool[index]\n      try {\n        item.editor.dispose()\n        this.pool.splice(index, 1)\n\n        this.stats.destroyed++\n        this.stats.idle--\n        this.stats.total--\n      } catch (error) {\n        console.error('Failed to dispose editor:', error)\n      }\n    })\n\n    if (toRemove.length > 0) {\n      console.debug(`Cleaned up ${toRemove.length} idle editors`)\n    }\n  }\n\n  /**\n   * 获取池统计\n   */\n  getStats(): PoolStats {\n    return { ...this.stats }\n  }\n\n  /**\n   * 获取池大小\n   */\n  size(): number {\n    return this.pool.length\n  }\n\n  /**\n   * 获取活跃编辑器数量\n   */\n  activeCount(): number {\n    return this.pool.filter((item) => item.inUse).length\n  }\n\n  /**\n   * 获取空闲编辑器数量\n   */\n  idleCount(): number {\n    return this.pool.filter((item) => !item.inUse).length\n  }\n\n  /**\n   * 清空池\n   */\n  clear(): void {\n    this.pool.forEach((item) => {\n      try {\n        item.editor.dispose()\n      } catch (error) {\n        console.error('Failed to dispose editor:', error)\n      }\n    })\n\n    this.pool = []\n\n    this.stats = {\n      total: 0,\n      active: 0,\n      idle: 0,\n      created: this.stats.created,\n      reused: this.stats.reused,\n      destroyed: this.stats.destroyed + this.pool.length,\n    }\n  }\n\n  /**\n   * 销毁池\n   */\n  dispose(): void {\n    if (this.cleanupInterval) {\n      clearInterval(this.cleanupInterval)\n      this.cleanupInterval = null\n    }\n\n    this.clear()\n  }\n\n  /**\n   * 生成池报告\n   */\n  generateReport(): string {\n    const stats = this.getStats()\n\n    return `\nEditor Pool Report\n==========================================\nTotal Editors: ${stats.total}\nActive: ${stats.active}\nIdle: ${stats.idle}\nCreated: ${stats.created}\nReused: ${stats.reused}\nDestroyed: ${stats.destroyed}\nReuse Rate: ${stats.reused > 0 ? ((stats.reused / stats.created) * 100).toFixed(2) : 0}%\n==========================================\n    `.trim()\n  }\n}\n\n"],"names":["n","Object","defineProperty","r","i","t","e","enumerable","configurable","writable","value","l","EditorPool","constructor","editorFactory","options","__publicField","this","total","active","idle","created","reused","destroyed","minSize","maxSize","maxIdleTime","warmup","warmUp","startCleanup","count","container","createHiddenContainer","editor","pool","push","inUse","lastUsed","Date","now","usageCount","stats","length","document","createElement","style","position","top","left","width","height","body","appendChild","acquire","idleItem","find","item","release","resetEditor","setValue","error","cleanupInterval","setInterval","cleanup","toRemove","forEach","index","reverse","dispose","splice","getStats","size","activeCount","filter","idleCount","clear","clearInterval","generateReport","toFixed","trim"],"mappings":"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"}