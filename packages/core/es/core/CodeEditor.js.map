{"version":3,"file":"CodeEditor.js","sources":["../../src/core/CodeEditor.ts"],"sourcesContent":["import * as monaco from 'monaco-editor'\r\nimport { normalizeLanguage } from '../utils/language-utils'\r\nimport type {\r\n  CodeEditorConfig,\r\n  CodeEditorOptions,\r\n  EditorLanguage,\r\n  EditorTheme,\r\n  EditorState\r\n} from '../types'\r\n\r\n/**\r\n * 代码编辑器核心类\r\n * 基于 Monaco Editor 的高性能、框架无关的代码编辑器\r\n */\r\nexport class CodeEditor {\r\n  private editor: monaco.editor.IStandaloneCodeEditor | null = null\r\n  private container: HTMLElement\r\n  private config: CodeEditorConfig\r\n  private disposables: monaco.IDisposable[] = []\r\n\r\n  /**\r\n   * 创建代码编辑器实例\r\n   * @param container - 编辑器容器元素\r\n   * @param config - 编辑器配置\r\n   */\r\n  constructor(container: HTMLElement, config: CodeEditorConfig = {}) {\r\n    this.container = container\r\n    this.config = config\r\n    this.init()\r\n  }\r\n\r\n  /**\r\n   * 初始化编辑器\r\n   */\r\n  private init(): void {\r\n    const options = this.buildMonacoOptions()\r\n\r\n    this.editor = monaco.editor.create(this.container, options)\r\n\r\n    this.setupEventListeners()\r\n\r\n    // 触发就绪事件\r\n    if (this.config.on?.ready) {\r\n      this.config.on.ready(this.editor)\r\n    }\r\n\r\n    // 响应容器大小变化\r\n    this.setupResizeObserver()\r\n  }\r\n\r\n  /**\r\n   * 构建 Monaco 编辑器选项\r\n   */\r\n  private buildMonacoOptions(): monaco.editor.IStandaloneEditorConstructionOptions {\r\n    const {\r\n      language = 'javascript',\r\n      theme = 'vs-dark',\r\n      value = '',\r\n      readOnly = false,\r\n      autoComplete = true,\r\n      folding = true,\r\n      lineNumbers = 'on',\r\n      minimap = true,\r\n      fontSize = 14,\r\n      tabSize = 2,\r\n      insertSpaces = true,\r\n      wordWrap = 'off',\r\n      scrollbar = {},\r\n      monacoOptions = {}\r\n    } = this.config\r\n\r\n    // Normalize language names (tsx -> typescriptreact, etc.)\r\n    const normalizedLanguage = normalizeLanguage(language)\r\n\r\n    return {\r\n      value,\r\n      language: normalizedLanguage,\r\n      theme,\r\n      readOnly,\r\n      fontSize,\r\n      tabSize,\r\n      insertSpaces,\r\n      wordWrap,\r\n      lineNumbers,\r\n      folding,\r\n      automaticLayout: true,\r\n      minimap: {\r\n        enabled: minimap\r\n      },\r\n      scrollbar: {\r\n        vertical: scrollbar.vertical || 'auto',\r\n        horizontal: scrollbar.horizontal || 'auto',\r\n        verticalScrollbarSize: scrollbar.verticalScrollbarSize || 10,\r\n        horizontalScrollbarSize: scrollbar.horizontalScrollbarSize || 10,\r\n        useShadows: false\r\n      },\r\n      quickSuggestions: autoComplete,\r\n      suggestOnTriggerCharacters: autoComplete,\r\n      parameterHints: {\r\n        enabled: autoComplete\r\n      },\r\n      ...monacoOptions\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 设置事件监听器\r\n   */\r\n  private setupEventListeners(): void {\r\n    if (!this.editor) return\r\n\r\n    const { on } = this.config\r\n\r\n    // 内容改变事件\r\n    if (on?.change) {\r\n      const changeDisposable = this.editor.onDidChangeModelContent((e) => {\r\n        on.change!(this.getValue(), e)\r\n      })\r\n      this.disposables.push(changeDisposable)\r\n    }\r\n\r\n    // 光标位置改变事件\r\n    if (on?.cursorChange) {\r\n      const cursorDisposable = this.editor.onDidChangeCursorPosition((e) => {\r\n        on.cursorChange!(e.position)\r\n      })\r\n      this.disposables.push(cursorDisposable)\r\n    }\r\n\r\n    // 聚焦事件\r\n    if (on?.focus) {\r\n      const focusDisposable = this.editor.onDidFocusEditorText(() => {\r\n        on.focus!()\r\n      })\r\n      this.disposables.push(focusDisposable)\r\n    }\r\n\r\n    // 失焦事件\r\n    if (on?.blur) {\r\n      const blurDisposable = this.editor.onDidBlurEditorText(() => {\r\n        on.blur!()\r\n      })\r\n      this.disposables.push(blurDisposable)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 设置 ResizeObserver 以响应容器大小变化\r\n   */\r\n  private setupResizeObserver(): void {\r\n    if (!this.editor) return\r\n\r\n    const resizeObserver = new ResizeObserver(() => {\r\n      this.editor?.layout()\r\n    })\r\n\r\n    resizeObserver.observe(this.container)\r\n\r\n    // 将 ResizeObserver 添加到 disposables\r\n    this.disposables.push({\r\n      dispose: () => resizeObserver.disconnect()\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 获取编辑器值\r\n   */\r\n  getValue(): string {\r\n    return this.editor?.getValue() || ''\r\n  }\r\n\r\n  /**\r\n   * 设置编辑器值\r\n   */\r\n  setValue(value: string): void {\r\n    this.editor?.setValue(value)\r\n  }\r\n\r\n  /**\r\n   * 获取选中的文本\r\n   */\r\n  getSelection(): string {\r\n    if (!this.editor) return ''\r\n    const selection = this.editor.getSelection()\r\n    if (!selection) return ''\r\n    return this.editor.getModel()?.getValueInRange(selection) || ''\r\n  }\r\n\r\n  /**\r\n   * 设置选中的文本\r\n   */\r\n  setSelection(selection: monaco.IRange): void {\r\n    this.editor?.setSelection(selection)\r\n  }\r\n\r\n  /**\r\n   * 插入文本\r\n   */\r\n  insertText(text: string, position?: monaco.IPosition): void {\r\n    if (!this.editor) return\r\n\r\n    const pos = position || this.editor.getPosition()\r\n    if (!pos) return\r\n\r\n    this.editor.executeEdits('insert', [\r\n      {\r\n        range: new monaco.Range(pos.lineNumber, pos.column, pos.lineNumber, pos.column),\r\n        text\r\n      }\r\n    ])\r\n  }\r\n\r\n  /**\r\n   * 格式化代码\r\n   */\r\n  async format(): Promise<void> {\r\n    if (!this.editor) return\r\n    await this.editor.getAction('editor.action.formatDocument')?.run()\r\n  }\r\n\r\n  /**\r\n   * 设置语言\r\n   */\r\n  setLanguage(language: EditorLanguage): void {\r\n    if (!this.editor) return\r\n    const model = this.editor.getModel()\r\n    if (model) {\r\n      // Normalize language names\r\n      const normalizedLanguage = normalizeLanguage(language)\r\n      monaco.editor.setModelLanguage(model, normalizedLanguage)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 设置主题\r\n   */\r\n  setTheme(theme: EditorTheme): void {\r\n    monaco.editor.setTheme(theme)\r\n  }\r\n\r\n  /**\r\n   * 设置只读\r\n   */\r\n  setReadOnly(readOnly: boolean): void {\r\n    this.editor?.updateOptions({ readOnly })\r\n  }\r\n\r\n  /**\r\n   * 聚焦编辑器\r\n   */\r\n  focus(): void {\r\n    this.editor?.focus()\r\n  }\r\n\r\n  /**\r\n   * 获取光标位置\r\n   */\r\n  getPosition(): monaco.Position | null {\r\n    return this.editor?.getPosition() || null\r\n  }\r\n\r\n  /**\r\n   * 设置光标位置\r\n   */\r\n  setPosition(position: monaco.IPosition): void {\r\n    this.editor?.setPosition(position)\r\n  }\r\n\r\n  /**\r\n   * 撤销\r\n   */\r\n  undo(): void {\r\n    this.editor?.trigger('keyboard', 'undo', null)\r\n  }\r\n\r\n  /**\r\n   * 重做\r\n   */\r\n  redo(): void {\r\n    this.editor?.trigger('keyboard', 'redo', null)\r\n  }\r\n\r\n  /**\r\n   * 获取 Monaco 编辑器实例\r\n   */\r\n  getEditor(): monaco.editor.IStandaloneCodeEditor {\r\n    if (!this.editor) {\r\n      throw new Error('Editor is not initialized')\r\n    }\r\n    return this.editor\r\n  }\r\n\r\n  /**\r\n   * 更新选项\r\n   */\r\n  updateOptions(options: CodeEditorOptions): void {\r\n    if (!this.editor) return\r\n\r\n    // 更新配置\r\n    this.config = { ...this.config, ...options }\r\n\r\n    // 更新 Monaco 选项\r\n    const monacoOptions = this.buildMonacoOptions()\r\n    this.editor.updateOptions(monacoOptions)\r\n\r\n    // 如果语言改变，更新语言\r\n    if (options.language) {\r\n      this.setLanguage(options.language)\r\n    }\r\n\r\n    // 如果主题改变，更新主题\r\n    if (options.theme) {\r\n      this.setTheme(options.theme)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取编辑器状态\r\n   */\r\n  getState(): EditorState {\r\n    const position = this.getPosition()\r\n    const model = this.editor?.getModel()\r\n\r\n    return {\r\n      language: (model?.getLanguageId() || 'javascript') as EditorLanguage,\r\n      theme: this.config.theme || 'vs-dark',\r\n      position,\r\n      lineNumber: position?.lineNumber || 0,\r\n      column: position?.column || 0,\r\n      lineCount: model?.getLineCount() || 0,\r\n      readOnly: this.config.readOnly || false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 销毁编辑器\r\n   */\r\n  dispose(): void {\r\n    // 清理所有事件监听器\r\n    this.disposables.forEach(d => d.dispose())\r\n    this.disposables = []\r\n\r\n    // 销毁编辑器实例\r\n    this.editor?.dispose()\r\n    this.editor = null\r\n\r\n    // 触发销毁事件\r\n    if (this.config.on?.dispose) {\r\n      this.config.on.dispose()\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 创建代码编辑器的便捷函数\r\n */\r\nexport function createCodeEditor(\r\n  container: HTMLElement | string,\r\n  config: CodeEditorConfig = {}\r\n): CodeEditor {\r\n  const element = typeof container === 'string'\r\n    ? document.querySelector<HTMLElement>(container)\r\n    : container\r\n\r\n  if (!element) {\r\n    throw new Error('Container element not found')\r\n  }\r\n\r\n  return new CodeEditor(element, config)\r\n}\r\n"],"names":["E","Object","defineProperty","s","o","e","t","enumerable","configurable","writable","value","C","CodeEditor","constructor","container","config","__publicField","this","init","options","buildMonacoOptions","editor","monaco","create","setupEventListeners","on","ready","setupResizeObserver","language","theme","readOnly","autoComplete","folding","lineNumbers","minimap","fontSize","tabSize","insertSpaces","wordWrap","scrollbar","monacoOptions","normalizeLanguage","automaticLayout","enabled","vertical","horizontal","verticalScrollbarSize","horizontalScrollbarSize","useShadows","quickSuggestions","suggestOnTriggerCharacters","parameterHints","change","changeDisposable","onDidChangeModelContent","getValue","disposables","push","cursorChange","cursorDisposable","onDidChangeCursorPosition","position","focus","focusDisposable","onDidFocusEditorText","blur","blurDisposable","onDidBlurEditorText","resizeObserver","ResizeObserver","layout","observe","dispose","disconnect","setValue","getSelection","selection","getModel","getValueInRange","setSelection","insertText","text","pos","getPosition","executeEdits","range","Range","lineNumber","column","format","getAction","run","setLanguage","model","normalizedLanguage","setModelLanguage","setTheme","setReadOnly","updateOptions","setPosition","undo","trigger","redo","getEditor","Error","getState","getLanguageId","lineCount","getLineCount","forEach","d","createCodeEditor","element","document","querySelector"],"mappings":"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"}