{"version":3,"file":"MemoryManager.js","sources":["../../src/core/MemoryManager.ts"],"sourcesContent":["/**\n * 内存管理器\n * 监控和优化内存使用\n */\n\nexport interface MemoryStats {\n  usedHeapSize: number\n  totalHeapSize: number\n  heapLimit: number\n  usagePercentage: number\n  timestamp: number\n}\n\nexport interface MemoryThreshold {\n  warning: number // 警告阈值（百分比）\n  critical: number // 严重阈值（百分比）\n}\n\nexport type MemoryCallback = (stats: MemoryStats) => void\n\n/**\n * 内存管理器类\n */\nexport class MemoryManager {\n  private thresholds: MemoryThreshold = {\n    warning: 75,\n    critical: 90,\n  }\n  private callbacks = new Set<MemoryCallback>()\n  private monitoringInterval: ReturnType<typeof setInterval> | null = null\n  private weakReferences = new WeakMap<object, string>()\n  private referenceRegistry = new FinalizationRegistry<string>((id) => {\n    console.debug(`Object ${id} was garbage collected`)\n  })\n\n  /**\n   * 设置内存阈值\n   */\n  setThresholds(thresholds: Partial<MemoryThreshold>): void {\n    this.thresholds = { ...this.thresholds, ...thresholds }\n  }\n\n  /**\n   * 获取内存统计\n   */\n  getMemoryStats(): MemoryStats | null {\n    if (!('memory' in performance)) {\n      return null\n    }\n\n    const memory = (performance as {\n      memory: {\n        usedJSHeapSize: number\n        totalJSHeapSize: number\n        jsHeapSizeLimit: number\n      }\n    }).memory\n\n    const usagePercentage = (memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100\n\n    return {\n      usedHeapSize: memory.usedJSHeapSize,\n      totalHeapSize: memory.totalJSHeapSize,\n      heapLimit: memory.jsHeapSizeLimit,\n      usagePercentage,\n      timestamp: Date.now(),\n    }\n  }\n\n  /**\n   * 检查内存状态\n   */\n  checkMemoryStatus(): 'normal' | 'warning' | 'critical' | null {\n    const stats = this.getMemoryStats()\n\n    if (!stats) {\n      return null\n    }\n\n    if (stats.usagePercentage >= this.thresholds.critical) {\n      return 'critical'\n    }\n\n    if (stats.usagePercentage >= this.thresholds.warning) {\n      return 'warning'\n    }\n\n    return 'normal'\n  }\n\n  /**\n   * 监听内存变化\n   */\n  onMemoryChange(callback: MemoryCallback): () => void {\n    this.callbacks.add(callback)\n\n    return () => {\n      this.callbacks.delete(callback)\n    }\n  }\n\n  /**\n   * 开始监控内存\n   */\n  startMonitoring(interval = 5000): void {\n    if (this.monitoringInterval) {\n      return\n    }\n\n    this.monitoringInterval = setInterval(() => {\n      const stats = this.getMemoryStats()\n\n      if (stats) {\n        this.callbacks.forEach((callback) => callback(stats))\n\n        const status = this.checkMemoryStatus()\n\n        if (status === 'critical') {\n          console.error('Critical memory usage!', stats)\n          this.triggerGarbageCollection()\n        } else if (status === 'warning') {\n          console.warn('High memory usage!', stats)\n        }\n      }\n    }, interval)\n  }\n\n  /**\n   * 停止监控内存\n   */\n  stopMonitoring(): void {\n    if (this.monitoringInterval) {\n      clearInterval(this.monitoringInterval)\n      this.monitoringInterval = null\n    }\n  }\n\n  /**\n   * 触发垃圾回收（仅在某些环境可用）\n   */\n  triggerGarbageCollection(): void {\n    if (globalThis.gc) {\n      try {\n        globalThis.gc()\n        console.debug('Garbage collection triggered')\n      } catch (error) {\n        console.warn('Failed to trigger garbage collection:', error)\n      }\n    }\n  }\n\n  /**\n   * 注册对象用于内存泄漏检测\n   */\n  registerObject(obj: object, id: string): void {\n    this.weakReferences.set(obj, id)\n    this.referenceRegistry.register(obj, id)\n  }\n\n  /**\n   * 检测内存泄漏\n   */\n  async detectLeaks(timeout = 5000): Promise<string[]> {\n    const leakedObjects: string[] = []\n    const registeredObjects = new Map<object, string>()\n\n    // 创建测试对象\n    for (let i = 0; i < 100; i++) {\n      const obj = { test: i }\n      const id = `test-${i}`\n      registeredObjects.set(obj, id)\n      this.registerObject(obj, id)\n    }\n\n    // 清除引用\n    registeredObjects.clear()\n\n    // 尝试触发 GC\n    this.triggerGarbageCollection()\n\n    // 等待一段时间\n    await new Promise((resolve) => setTimeout(resolve, timeout))\n\n    return leakedObjects\n  }\n\n  /**\n   * 清理大型对象\n   */\n  clearLargeObjects<T>(\n    collection: T[],\n    predicate: (item: T) => boolean = () => true\n  ): number {\n    let cleared = 0\n    for (let i = collection.length - 1; i >= 0; i--) {\n      if (predicate(collection[i])) {\n        collection.splice(i, 1)\n        cleared++\n      }\n    }\n    return cleared\n  }\n\n  /**\n   * 优化字符串内存\n   */\n  deduplicateStrings(strings: string[]): string[] {\n    const seen = new Set<string>()\n    const deduplicated: string[] = []\n\n    for (const str of strings) {\n      if (!seen.has(str)) {\n        seen.add(str)\n        deduplicated.push(str)\n      }\n    }\n\n    return deduplicated\n  }\n\n  /**\n   * 获取对象大小估算\n   */\n  estimateObjectSize(obj: unknown): number {\n    const seen = new WeakSet()\n\n    function sizeOf(value: unknown): number {\n      if (value === null || value === undefined) {\n        return 0\n      }\n\n      switch (typeof value) {\n        case 'boolean':\n          return 4\n        case 'number':\n          return 8\n        case 'string':\n          return (value as string).length * 2\n        case 'object':\n          if (seen.has(value as object)) {\n            return 0\n          }\n\n          seen.add(value as object)\n\n          if (Array.isArray(value)) {\n            return value.reduce((total, item) => total + sizeOf(item), 0)\n          }\n\n          return Object.keys(value).reduce((total, key) => {\n            return total + key.length * 2 + sizeOf((value as Record<string, unknown>)[key])\n          }, 0)\n\n        default:\n          return 0\n      }\n    }\n\n    return sizeOf(obj)\n  }\n\n  /**\n   * 创建内存快照\n   */\n  createSnapshot(): {\n    timestamp: number\n    stats: MemoryStats | null\n    status: string | null\n  } {\n    return {\n      timestamp: Date.now(),\n      stats: this.getMemoryStats(),\n      status: this.checkMemoryStatus(),\n    }\n  }\n\n  /**\n   * 比较两个快照\n   */\n  compareSnapshots(\n    snapshot1: ReturnType<typeof this.createSnapshot>,\n    snapshot2: ReturnType<typeof this.createSnapshot>\n  ): {\n    heapGrowth: number\n    timeElapsed: number\n    growthRate: number\n  } | null {\n    if (!snapshot1.stats || !snapshot2.stats) {\n      return null\n    }\n\n    const heapGrowth = snapshot2.stats.usedHeapSize - snapshot1.stats.usedHeapSize\n    const timeElapsed = snapshot2.timestamp - snapshot1.timestamp\n    const growthRate = heapGrowth / (timeElapsed / 1000) // bytes per second\n\n    return {\n      heapGrowth,\n      timeElapsed,\n      growthRate,\n    }\n  }\n\n  /**\n   * 格式化字节大小\n   */\n  formatBytes(bytes: number, decimals = 2): string {\n    if (bytes === 0) return '0 Bytes'\n\n    const k = 1024\n    const dm = decimals < 0 ? 0 : decimals\n    const sizes = ['Bytes', 'KB', 'MB', 'GB']\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\n\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]\n  }\n\n  /**\n   * 生成内存报告\n   */\n  generateReport(): string {\n    const stats = this.getMemoryStats()\n\n    if (!stats) {\n      return 'Memory statistics not available'\n    }\n\n    return `\nMemory Report (${new Date(stats.timestamp).toLocaleString()})\n==========================================\nUsed Heap: ${this.formatBytes(stats.usedHeapSize)}\nTotal Heap: ${this.formatBytes(stats.totalHeapSize)}\nHeap Limit: ${this.formatBytes(stats.heapLimit)}\nUsage: ${stats.usagePercentage.toFixed(2)}%\nStatus: ${this.checkMemoryStatus()}\n==========================================\n    `.trim()\n  }\n\n  /**\n   * 销毁管理器\n   */\n  dispose(): void {\n    this.stopMonitoring()\n    this.callbacks.clear()\n  }\n}\n\n// 导出全局实例\nexport const globalMemoryManager = new MemoryManager()\n\n"],"names":["c","Object","defineProperty","o","n","e","r","enumerable","configurable","writable","value","l","MemoryManager","constructor","__publicField","this","warning","critical","Set","WeakMap","FinalizationRegistry","id","setThresholds","thresholds","getMemoryStats","performance","memory","usagePercentage","usedJSHeapSize","jsHeapSizeLimit","usedHeapSize","totalHeapSize","totalJSHeapSize","heapLimit","timestamp","Date","now","checkMemoryStatus","stats","onMemoryChange","callback","callbacks","add","delete","startMonitoring","interval","monitoringInterval","setInterval","forEach","status","triggerGarbageCollection","stopMonitoring","clearInterval","globalThis","gc","error","registerObject","obj","weakReferences","set","referenceRegistry","register","detectLeaks","timeout","registeredObjects","Map","i","test","clear","Promise","resolve","setTimeout","clearLargeObjects","collection","predicate","cleared","length","splice","deduplicateStrings","strings","seen","deduplicated","str","has","push","estimateObjectSize","WeakSet","sizeOf","Array","isArray","reduce","total","item","keys","key","createSnapshot","compareSnapshots","snapshot1","snapshot2","heapGrowth","timeElapsed","growthRate","formatBytes","bytes","decimals","dm","Math","floor","log","parseFloat","pow","toFixed","generateReport","toLocaleString","trim","dispose","globalMemoryManager"],"mappings":"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"}