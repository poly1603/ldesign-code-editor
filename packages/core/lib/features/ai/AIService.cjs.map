{"version":3,"file":"AIService.cjs","sources":["../../../src/features/ai/AIService.ts"],"sourcesContent":["/**\n * AI 服务\n * 提供 AI 功能的统一接口\n */\n\nimport type {\n  AIConfig,\n  AICompletionRequest,\n  AICompletionResponse,\n  AIError,\n  CodeContext,\n  NaturalLanguageRequest,\n  CodeExplanation,\n  CodeDocumentation,\n} from '../../types/ai'\n\n/**\n * AI 服务类\n */\nexport class AIService {\n  private config: AIConfig\n  private requestQueue: Array<() => Promise<unknown>> = []\n  private isProcessing = false\n  private rateLimitDelay = 1000 // 1 second between requests\n\n  constructor(config: AIConfig) {\n    this.config = config\n  }\n\n  /**\n   * 更新配置\n   */\n  updateConfig(config: Partial<AIConfig>): void {\n    this.config = { ...this.config, ...config }\n  }\n\n  /**\n   * 获取代码补全\n   */\n  async getCompletion(request: AICompletionRequest): Promise<AICompletionResponse> {\n    return this.queueRequest(async () => {\n      try {\n        const response = await this.makeAPIRequest('completions', {\n          prompt: this.buildPrompt(request),\n          max_tokens: request.maxTokens || this.config.maxTokens || 100,\n          temperature: request.temperature || this.config.temperature || 0.7,\n          stop: request.stopSequences || ['\\n\\n'],\n        })\n\n        return {\n          completion: response.choices[0].text.trim(),\n          confidence: response.choices[0].finish_reason === 'stop' ? 0.9 : 0.7,\n          alternatives: response.choices.slice(1).map((c: { text: string }) => c.text.trim()),\n          metadata: {\n            model: response.model,\n            usage: response.usage,\n          },\n        }\n      } catch (error) {\n        throw this.handleError(error)\n      }\n    })\n  }\n\n  /**\n   * 自然语言转代码\n   */\n  async naturalLanguageToCode(request: NaturalLanguageRequest): Promise<string> {\n    return this.queueRequest(async () => {\n      const prompt = this.buildNL2CodePrompt(request)\n\n      try {\n        const response = await this.makeAPIRequest('completions', {\n          prompt,\n          max_tokens: 200,\n          temperature: 0.5,\n        })\n\n        return response.choices[0].text.trim()\n      } catch (error) {\n        throw this.handleError(error)\n      }\n    })\n  }\n\n  /**\n   * 解释代码\n   */\n  async explainCode(code: string, context?: CodeContext): Promise<CodeExplanation> {\n    return this.queueRequest(async () => {\n      const prompt = `Explain the following ${context?.language || ''} code:\\n\\n${code}\\n\\nProvide a clear explanation of what this code does:`\n\n      try {\n        const response = await this.makeAPIRequest('completions', {\n          prompt,\n          max_tokens: 300,\n          temperature: 0.3,\n        })\n\n        const explanation = response.choices[0].text.trim()\n\n        return {\n          summary: explanation.split('\\n')[0],\n          details: explanation,\n          complexity: this.assessComplexity(code),\n          suggestions: this.extractSuggestions(explanation),\n        }\n      } catch (error) {\n        throw this.handleError(error)\n      }\n    })\n  }\n\n  /**\n   * 生成文档\n   */\n  async generateDocumentation(code: string, language?: string): Promise<CodeDocumentation> {\n    return this.queueRequest(async () => {\n      const prompt = `Generate JSDoc/documentation for the following ${language || ''} code:\\n\\n${code}\\n\\nProvide comprehensive documentation:`\n\n      try {\n        const response = await this.makeAPIRequest('completions', {\n          prompt,\n          max_tokens: 400,\n          temperature: 0.3,\n        })\n\n        const documentation = response.choices[0].text.trim()\n\n        return this.parseDocumentation(documentation)\n      } catch (error) {\n        throw this.handleError(error)\n      }\n    })\n  }\n\n  /**\n   * 修复代码错误\n   */\n  async fixCode(code: string, error: string, language?: string): Promise<string> {\n    return this.queueRequest(async () => {\n      const prompt = `Fix the following ${language || ''} code that has this error: \"${error}\"\\n\\nCode:\\n${code}\\n\\nFixed code:`\n\n      try {\n        const response = await this.makeAPIRequest('completions', {\n          prompt,\n          max_tokens: 300,\n          temperature: 0.5,\n        })\n\n        return response.choices[0].text.trim()\n      } catch (error) {\n        throw this.handleError(error)\n      }\n    })\n  }\n\n  /**\n   * 优化代码\n   */\n  async optimizeCode(code: string, language?: string): Promise<string> {\n    return this.queueRequest(async () => {\n      const prompt = `Optimize the following ${language || ''} code for better performance and readability:\\n\\n${code}\\n\\nOptimized code:`\n\n      try {\n        const response = await this.makeAPIRequest('completions', {\n          prompt,\n          max_tokens: 400,\n          temperature: 0.5,\n        })\n\n        return response.choices[0].text.trim()\n      } catch (error) {\n        throw this.handleError(error)\n      }\n    })\n  }\n\n  /**\n   * 队列请求\n   */\n  private async queueRequest<T>(request: () => Promise<T>): Promise<T> {\n    return new Promise((resolve, reject) => {\n      this.requestQueue.push(async () => {\n        try {\n          const result = await request()\n          resolve(result)\n        } catch (error) {\n          reject(error)\n        }\n      })\n\n      this.processQueue()\n    })\n  }\n\n  /**\n   * 处理请求队列\n   */\n  private async processQueue(): Promise<void> {\n    if (this.isProcessing || this.requestQueue.length === 0) {\n      return\n    }\n\n    this.isProcessing = true\n\n    while (this.requestQueue.length > 0) {\n      const request = this.requestQueue.shift()\n      if (request) {\n        await request()\n        await this.delay(this.rateLimitDelay)\n      }\n    }\n\n    this.isProcessing = false\n  }\n\n  /**\n   * 发起 API 请求\n   */\n  private async makeAPIRequest(endpoint: string, data: Record<string, unknown>): Promise<{\n    choices: Array<{ text: string; finish_reason: string }>\n    model: string\n    usage: Record<string, unknown>\n  }> {\n    const url = this.buildURL(endpoint)\n\n    const response = await fetch(url, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${this.config.apiKey}`,\n      },\n      body: JSON.stringify({\n        model: this.config.model || 'gpt-3.5-turbo',\n        ...data,\n      }),\n      signal: AbortSignal.timeout(this.config.timeout || 30000),\n    })\n\n    if (!response.ok) {\n      throw new Error(`API request failed: ${response.statusText}`)\n    }\n\n    return await response.json()\n  }\n\n  /**\n   * 构建 URL\n   */\n  private buildURL(endpoint: string): string {\n    const baseURL = this.config.baseURL || this.getDefaultBaseURL()\n    return `${baseURL}/${endpoint}`\n  }\n\n  /**\n   * 获取默认 Base URL\n   */\n  private getDefaultBaseURL(): string {\n    switch (this.config.provider) {\n      case 'openai':\n        return 'https://api.openai.com/v1'\n      case 'claude':\n        return 'https://api.anthropic.com/v1'\n      default:\n        throw new Error('Unknown AI provider or missing baseURL')\n    }\n  }\n\n  /**\n   * 构建提示词\n   */\n  private buildPrompt(request: AICompletionRequest): string {\n    let prompt = ''\n\n    if (request.context) {\n      prompt += `Context:\\n${request.context}\\n\\n`\n    }\n\n    if (request.language) {\n      prompt += `Language: ${request.language}\\n\\n`\n    }\n\n    prompt += `Complete the following code:\\n${request.prompt}`\n\n    return prompt\n  }\n\n  /**\n   * 构建自然语言转代码提示词\n   */\n  private buildNL2CodePrompt(request: NaturalLanguageRequest): string {\n    let prompt = `Convert the following natural language description to ${request.targetLanguage || 'JavaScript'} code:\\n\\n`\n    prompt += `\"${request.query}\"\\n\\n`\n\n    if (request.context) {\n      prompt += `Context:\\n`\n      prompt += `File: ${request.context.fileName || 'unknown'}\\n`\n      prompt += `Language: ${request.context.language || 'unknown'}\\n\\n`\n    }\n\n    prompt += `Code:`\n\n    return prompt\n  }\n\n  /**\n   * 评估代码复杂度\n   */\n  private assessComplexity(code: string): 'low' | 'medium' | 'high' {\n    const lines = code.split('\\n').length\n    const nestedBlocks = (code.match(/\\{/g) || []).length\n\n    if (lines < 10 && nestedBlocks < 3) {\n      return 'low'\n    } else if (lines < 50 && nestedBlocks < 10) {\n      return 'medium'\n    } else {\n      return 'high'\n    }\n  }\n\n  /**\n   * 提取建议\n   */\n  private extractSuggestions(explanation: string): string[] {\n    const suggestions: string[] = []\n    const lines = explanation.split('\\n')\n\n    for (const line of lines) {\n      if (line.includes('consider') || line.includes('should') || line.includes('could')) {\n        suggestions.push(line.trim())\n      }\n    }\n\n    return suggestions\n  }\n\n  /**\n   * 解析文档\n   */\n  private parseDocumentation(documentation: string): CodeDocumentation {\n    // 简单解析，实际应该更复杂\n    const lines = documentation.split('\\n')\n\n    return {\n      description: lines[0] || '',\n      parameters: [],\n      examples: [],\n      tags: [],\n    }\n  }\n\n  /**\n   * 处理错误\n   */\n  private handleError(error: unknown): AIError {\n    if (error instanceof Error) {\n      return {\n        code: 'AI_ERROR',\n        message: error.message,\n        details: error,\n      }\n    }\n\n    return {\n      code: 'UNKNOWN_ERROR',\n      message: 'An unknown error occurred',\n      details: error,\n    }\n  }\n\n  /**\n   * 延迟\n   */\n  private delay(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms))\n  }\n\n  /**\n   * 取消所有请求\n   */\n  cancelAll(): void {\n    this.requestQueue = []\n  }\n\n  /**\n   * 获取队列大小\n   */\n  getQueueSize(): number {\n    return this.requestQueue.length\n  }\n}\n\n"],"names":["a","Object","defineProperty","i","r","e","t","enumerable","configurable","writable","value","u","constructor","config","__publicField","this","updateConfig","getCompletion","request","queueRequest","async","response","makeAPIRequest","prompt","buildPrompt","max_tokens","maxTokens","temperature","stop","stopSequences","completion","choices","text","trim","confidence","finish_reason","alternatives","slice","map","c","metadata","model","usage","error","handleError","naturalLanguageToCode","buildNL2CodePrompt","explainCode","code","context","language","explanation","summary","split","details","complexity","assessComplexity","suggestions","extractSuggestions","generateDocumentation","documentation","parseDocumentation","fixCode","optimizeCode","Promise","resolve","reject","requestQueue","push","result","processQueue","isProcessing","length","shift","delay","rateLimitDelay","endpoint","data","url","buildURL","fetch","method","headers","Authorization","apiKey","body","JSON","stringify","signal","AbortSignal","timeout","ok","Error","statusText","json","baseURL","getDefaultBaseURL","provider","targetLanguage","query","fileName","lines","nestedBlocks","match","line","includes","description","parameters","examples","tags","message","ms","setTimeout","cancelAll","getQueueSize"],"mappings":"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"}