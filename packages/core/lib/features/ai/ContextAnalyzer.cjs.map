{"version":3,"file":"ContextAnalyzer.cjs","sources":["../../../src/features/ai/ContextAnalyzer.ts"],"sourcesContent":["/**\n * 代码上下文分析器\n * 分析编辑器中的代码上下文\n */\n\nimport type * as Monaco from 'monaco-editor'\nimport type { CodeContext } from '../../types/ai'\n\n/**\n * 上下文分析器类\n */\nexport class ContextAnalyzer {\n  /**\n   * 分析代码上下文\n   */\n  analyzeContext(model: Monaco.editor.ITextModel, position: Monaco.Position): CodeContext {\n    const fullText = model.getValue()\n    const offset = model.getOffsetAt(position)\n\n    const beforeCursor = fullText.substring(0, offset)\n    const afterCursor = fullText.substring(offset)\n    const currentLine = model.getLineContent(position.lineNumber)\n\n    const context: CodeContext = {\n      beforeCursor,\n      afterCursor,\n      currentLine,\n      language: model.getLanguageId(),\n      fileName: model.uri.path,\n      imports: this.extractImports(fullText),\n      functions: this.extractFunctions(fullText),\n      variables: this.extractVariables(fullText),\n    }\n\n    return context\n  }\n\n  /**\n   * 提取导入语句\n   */\n  private extractImports(code: string): string[] {\n    const imports: string[] = []\n    const importRegex = /import\\s+.*?\\s+from\\s+['\"](.*?)['\"]/g\n    const requireRegex = /require\\(['\"](.*?)['\"]\\)/g\n\n    let match\n\n    // ES6 imports\n    while ((match = importRegex.exec(code)) !== null) {\n      imports.push(match[1])\n    }\n\n    // CommonJS requires\n    while ((match = requireRegex.exec(code)) !== null) {\n      imports.push(match[1])\n    }\n\n    return [...new Set(imports)]\n  }\n\n  /**\n   * 提取函数定义\n   */\n  private extractFunctions(code: string): string[] {\n    const functions: string[] = []\n\n    // 函数声明\n    const functionRegex = /function\\s+(\\w+)\\s*\\(/g\n    // 箭头函数\n    const arrowFunctionRegex = /(?:const|let|var)\\s+(\\w+)\\s*=\\s*(?:async\\s*)?\\([^)]*\\)\\s*=>/g\n    // 类方法\n    const methodRegex = /(\\w+)\\s*\\([^)]*\\)\\s*\\{/g\n\n    let match\n\n    while ((match = functionRegex.exec(code)) !== null) {\n      functions.push(match[1])\n    }\n\n    while ((match = arrowFunctionRegex.exec(code)) !== null) {\n      functions.push(match[1])\n    }\n\n    while ((match = methodRegex.exec(code)) !== null) {\n      if (!['if', 'for', 'while', 'switch'].includes(match[1])) {\n        functions.push(match[1])\n      }\n    }\n\n    return [...new Set(functions)]\n  }\n\n  /**\n   * 提取变量声明\n   */\n  private extractVariables(code: string): string[] {\n    const variables: string[] = []\n    const variableRegex = /(?:const|let|var)\\s+(\\w+)/g\n\n    let match\n\n    while ((match = variableRegex.exec(code)) !== null) {\n      variables.push(match[1])\n    }\n\n    return [...new Set(variables)]\n  }\n\n  /**\n   * 获取当前作用域\n   */\n  getCurrentScope(model: Monaco.editor.ITextModel, position: Monaco.Position): string {\n    const fullText = model.getValue()\n    const offset = model.getOffsetAt(position)\n    const beforeCursor = fullText.substring(0, offset)\n\n    // 简单的作用域检测（基于花括号）\n    let braceCount = 0\n    let scopeStart = 0\n\n    for (let i = beforeCursor.length - 1; i >= 0; i--) {\n      if (beforeCursor[i] === '}') {\n        braceCount++\n      } else if (beforeCursor[i] === '{') {\n        if (braceCount === 0) {\n          scopeStart = i\n          break\n        }\n        braceCount--\n      }\n    }\n\n    return fullText.substring(scopeStart, offset)\n  }\n\n  /**\n   * 检测当前位置的上下文类型\n   */\n  detectContextType(context: CodeContext): 'import' | 'function' | 'class' | 'variable' | 'comment' | 'string' | 'unknown' {\n    const { currentLine, beforeCursor } = context\n\n    // 检测注释\n    if (currentLine.trim().startsWith('//') || currentLine.trim().startsWith('/*')) {\n      return 'comment'\n    }\n\n    // 检测字符串\n    const stringMatch = beforeCursor.match(/['\"`](?:[^'\"`\\\\]|\\\\.)*$/)\n    if (stringMatch) {\n      return 'string'\n    }\n\n    // 检测导入\n    if (currentLine.includes('import') || currentLine.includes('require')) {\n      return 'import'\n    }\n\n    // 检测函数\n    if (currentLine.includes('function') || /=>\\s*{?$/.test(beforeCursor)) {\n      return 'function'\n    }\n\n    // 检测类\n    if (currentLine.includes('class')) {\n      return 'class'\n    }\n\n    // 检测变量\n    if (/(?:const|let|var)\\s+\\w*$/.test(beforeCursor)) {\n      return 'variable'\n    }\n\n    return 'unknown'\n  }\n\n  /**\n   * 获取光标前的词\n   */\n  getWordBeforeCursor(model: Monaco.editor.ITextModel, position: Monaco.Position): string {\n    const lineContent = model.getLineContent(position.lineNumber)\n    const wordRegex = /[\\w.]+$/\n    const match = lineContent.substring(0, position.column - 1).match(wordRegex)\n\n    return match ? match[0] : ''\n  }\n\n  /**\n   * 获取可用的补全上下文\n   */\n  getCompletionContext(context: CodeContext): {\n    inFunction: boolean\n    inClass: boolean\n    inString: boolean\n    inComment: boolean\n    availableVariables: string[]\n    availableFunctions: string[]\n  } {\n    const contextType = this.detectContextType(context)\n\n    return {\n      inFunction: contextType === 'function',\n      inClass: contextType === 'class',\n      inString: contextType === 'string',\n      inComment: contextType === 'comment',\n      availableVariables: context.variables || [],\n      availableFunctions: context.functions || [],\n    }\n  }\n}\n\n"],"names":["analyzeContext","model","position","fullText","getValue","offset","getOffsetAt","beforeCursor","substring","afterCursor","currentLine","getLineContent","lineNumber","language","getLanguageId","fileName","uri","path","imports","this","extractImports","functions","extractFunctions","variables","extractVariables","code","importRegex","requireRegex","match","exec","push","Set","functionRegex","arrowFunctionRegex","methodRegex","includes","variableRegex","getCurrentScope","braceCount","scopeStart","i","length","detectContextType","context","trim","startsWith","test","getWordBeforeCursor","column","getCompletionContext","contextType","inFunction","inClass","inString","inComment","availableVariables","availableFunctions"],"mappings":"qCAWO,MAIL,cAAAA,CAAeC,EAAiCC,GAC9C,MAAMC,EAAWF,EAAMG,WACjBC,EAASJ,EAAMK,YAAYJ,GAiBjC,MAX6B,CAC3BK,aALmBJ,EAASK,UAAU,EAAGH,GAMzCI,YALkBN,EAASK,UAAUH,GAMrCK,YALkBT,EAAMU,eAAeT,EAASU,YAMhDC,SAAUZ,EAAMa,gBAChBC,SAAUd,EAAMe,IAAIC,KACpBC,QAASC,KAAKC,eAAejB,GAC7BkB,UAAWF,KAAKG,iBAAiBnB,GACjCoB,UAAWJ,KAAKK,iBAAiBrB,GAIrC,CAKQ,cAAAiB,CAAeK,GACrB,MAAMP,EAAoB,GACpBQ,EAAc,uCACdC,EAAe,4BAErB,IAAIC,EAGJ,KAA4C,QAApCA,EAAQF,EAAYG,KAAKJ,KAC/BP,EAAQY,KAAKF,EAAM,IAIrB,KAA6C,QAArCA,EAAQD,EAAaE,KAAKJ,KAChCP,EAAQY,KAAKF,EAAM,IAGrB,MAAO,IAAI,IAAIG,IAAIb,GACrB,CAKQ,gBAAAI,CAAiBG,GACvB,MAAMJ,EAAsB,GAGtBW,EAAgB,yBAEhBC,EAAqB,+DAErBC,EAAc,0BAEpB,IAAIN,EAEJ,KAA8C,QAAtCA,EAAQI,EAAcH,KAAKJ,KACjCJ,EAAUS,KAAKF,EAAM,IAGvB,KAAmD,QAA3CA,EAAQK,EAAmBJ,KAAKJ,KACtCJ,EAAUS,KAAKF,EAAM,IAGvB,KAA4C,QAApCA,EAAQM,EAAYL,KAAKJ,KAC1B,CAAC,KAAM,MAAO,QAAS,UAAUU,SAASP,EAAM,KACnDP,EAAUS,KAAKF,EAAM,IAIzB,MAAO,IAAI,IAAIG,IAAIV,GACrB,CAKQ,gBAAAG,CAAiBC,GACvB,MAAMF,EAAsB,GACtBa,EAAgB,6BAEtB,IAAIR,EAEJ,KAA8C,QAAtCA,EAAQQ,EAAcP,KAAKJ,KACjCF,EAAUO,KAAKF,EAAM,IAGvB,MAAO,IAAI,IAAIG,IAAIR,GACrB,CAKA,eAAAc,CAAgBpC,EAAiCC,GAC/C,MAAMC,EAAWF,EAAMG,WACjBC,EAASJ,EAAMK,YAAYJ,GAC3BK,EAAeJ,EAASK,UAAU,EAAGH,GAG3C,IAAIiC,EAAa,EACbC,EAAa,EAEjB,IAAA,IAASC,EAAIjC,EAAakC,OAAS,EAAGD,GAAK,EAAGA,IAC5C,GAAwB,MAApBjC,EAAaiC,GACfF,SAAAA,GAC6B,MAApB/B,EAAaiC,GAAY,CAClC,GAAmB,IAAfF,EAAkB,CACpBC,EAAaC,EACb,KACF,CACAF,GACF,CAGF,OAAOnC,EAASK,UAAU+B,EAAYlC,EACxC,CAKA,iBAAAqC,CAAkBC,GAChB,MAAQjC,YAAAA,EAAaH,aAAAA,GAAiBoC,EAGtC,OAAIjC,EAAYkC,OAAOC,WAAW,OAASnC,EAAYkC,OAAOC,WAAW,MAChE,UAIWtC,EAAaqB,MAAM,2BAE9B,SAILlB,EAAYyB,SAAS,WAAazB,EAAYyB,SAAS,WAClD,SAILzB,EAAYyB,SAAS,aAAe,WAAWW,KAAKvC,GAC/C,WAILG,EAAYyB,SAAS,SAChB,QAIL,2BAA2BW,KAAKvC,GAC3B,WAGF,SACT,CAKA,mBAAAwC,CAAoB9C,EAAiCC,GACnD,MAEM0B,EAFc3B,EAAMU,eAAeT,EAASU,YAExBJ,UAAU,EAAGN,EAAS8C,OAAS,GAAGpB,MAD1C,WAGlB,OAAOA,EAAQA,EAAM,GAAK,EAC5B,CAKA,oBAAAqB,CAAqBN,GAQnB,MAAMO,EAAc/B,KAAKuB,kBAAkBC,GAE3C,MAAO,CACLQ,WAA4B,aAAhBD,EACZE,QAAyB,UAAhBF,EACTG,SAA0B,WAAhBH,EACVI,UAA2B,YAAhBJ,EACXK,mBAAoBZ,EAAQpB,WAAa,GACzCiC,mBAAoBb,EAAQtB,WAAa,GAE7C"}