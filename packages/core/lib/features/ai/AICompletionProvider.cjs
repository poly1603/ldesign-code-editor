"use strict";var e=require("./ContextAnalyzer.cjs"),n=Object.defineProperty,t=(e,t,i)=>(((e,t,i)=>{t in e?n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);exports.AICompletionProvider=class{constructor(n){t(this,"aiService"),t(this,"contextAnalyzer"),t(this,"options"),t(this,"debounceTimer",null),this.aiService=n.aiService,this.contextAnalyzer=new e.ContextAnalyzer,this.options={aiService:n.aiService,triggerCharacters:n.triggerCharacters||[".","("," "],debounceDelay:n.debounceDelay||300,maxSuggestions:n.maxSuggestions||5,enableInlineCompletion:!1!==n.enableInlineCompletion}}register(e,n){return e.languages.registerCompletionItemProvider(n,{triggerCharacters:this.options.triggerCharacters,provideCompletionItems:async(e,n,t,i)=>new Promise(t=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(async()=>{if(i.isCancellationRequested)t({suggestions:[]});else try{const i=this.contextAnalyzer.analyzeContext(e,n),o=(await this.getAICompletions(i)).map(e=>({label:e.displayText||e.text,kind:this.mapKind(e.kind),insertText:e.text,documentation:e.documentation,sortText:""+(1e3-e.score),range:{startLineNumber:n.lineNumber,startColumn:n.column,endLineNumber:n.lineNumber,endColumn:n.column}}));t({suggestions:o})}catch(e){t({suggestions:[]})}},this.options.debounceDelay)})})}registerInlineCompletion(e,n){return this.options.enableInlineCompletion&&e.languages.registerInlineCompletionsProvider?e.languages.registerInlineCompletionsProvider(n,{provideInlineCompletions:async(e,n,t,i)=>{if(i.isCancellationRequested)return{items:[]};try{const t=this.contextAnalyzer.analyzeContext(e,n);return{items:[{insertText:(await this.aiService.getCompletion({prompt:t.beforeCursor,context:this.buildContextString(t),language:t.language})).completion,range:{startLineNumber:n.lineNumber,startColumn:n.column,endLineNumber:n.lineNumber,endColumn:n.column}}]}}catch(e){return{items:[]}}},freeInlineCompletions:()=>{}}):null}async getAICompletions(e){try{const n=await this.aiService.getCompletion({prompt:e.beforeCursor,context:this.buildContextString(e),language:e.language,maxTokens:50}),t=[{text:n.completion,displayText:n.completion.split("\n")[0],documentation:"AI-generated completion",kind:this.inferKind(n.completion),score:100*(n.confidence||.5)}];return n.alternatives&&n.alternatives.forEach((e,i)=>{t.push({text:e,displayText:e.split("\n")[0],documentation:"AI-generated alternative",kind:this.inferKind(e),score:100*(n.confidence||.5)-10*(i+1)})}),t.slice(0,this.options.maxSuggestions)}catch(e){return[]}}buildContextString(e){let n="";return e.imports&&e.imports.length>0&&(n+=`Imports: ${e.imports.join(", ")}\n`),e.functions&&e.functions.length>0&&(n+=`Functions: ${e.functions.join(", ")}\n`),e.variables&&e.variables.length>0&&(n+=`Variables: ${e.variables.join(", ")}\n`),n}inferKind(e){return e.includes("function")||e.includes("=>")?"function":e.includes("class")?"class":e.includes("const")||e.includes("let")||e.includes("var")?"variable":e.includes("(")&&e.includes(")")?"method":"snippet"}mapKind(e){const n=globalThis.monaco;return n?{method:n.languages.CompletionItemKind.Method,function:n.languages.CompletionItemKind.Function,property:n.languages.CompletionItemKind.Property,variable:n.languages.CompletionItemKind.Variable,class:n.languages.CompletionItemKind.Class,snippet:n.languages.CompletionItemKind.Snippet}[e]||n.languages.CompletionItemKind.Text:0}dispose(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}};
//# sourceMappingURL=AICompletionProvider.cjs.map
