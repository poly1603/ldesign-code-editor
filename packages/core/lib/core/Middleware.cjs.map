{"version":3,"file":"Middleware.cjs","sources":["../../src/core/Middleware.ts"],"sourcesContent":["/**\n * 中间件系统\n * 实现编辑器操作的拦截和处理\n */\n\nexport type MiddlewareContext<T = unknown> = {\n  data: T\n  editor: unknown\n  timestamp: number\n  metadata?: Record<string, unknown>\n}\n\nexport type NextFunction = () => Promise<void> | void\n\nexport type MiddlewareFunction<T = unknown> = (\n  context: MiddlewareContext<T>,\n  next: NextFunction\n) => Promise<void> | void\n\n/**\n * 中间件管理器\n */\nexport class MiddlewareManager<T = unknown> {\n  private middlewares: MiddlewareFunction<T>[] = []\n\n  /**\n   * 添加中间件\n   */\n  use(middleware: MiddlewareFunction<T>): this {\n    this.middlewares.push(middleware)\n    return this\n  }\n\n  /**\n   * 移除中间件\n   */\n  remove(middleware: MiddlewareFunction<T>): boolean {\n    const index = this.middlewares.indexOf(middleware)\n    if (index !== -1) {\n      this.middlewares.splice(index, 1)\n      return true\n    }\n    return false\n  }\n\n  /**\n   * 清空所有中间件\n   */\n  clear(): void {\n    this.middlewares = []\n  }\n\n  /**\n   * 执行中间件链\n   */\n  async execute(context: MiddlewareContext<T>): Promise<void> {\n    let index = 0\n\n    const next = async (): Promise<void> => {\n      if (index >= this.middlewares.length) {\n        return\n      }\n\n      const middleware = this.middlewares[index++]\n      await middleware(context, next)\n    }\n\n    await next()\n  }\n\n  /**\n   * 获取中间件数量\n   */\n  size(): number {\n    return this.middlewares.length\n  }\n}\n\n/**\n * 内置中间件 - 日志记录\n */\nexport function loggingMiddleware<T>(\n  context: MiddlewareContext<T>,\n  next: NextFunction\n): void {\n  const start = Date.now()\n  console.debug('[Middleware] Start:', context)\n\n  next()\n\n  const duration = Date.now() - start\n  console.debug('[Middleware] End:', { duration, context })\n}\n\n/**\n * 内置中间件 - 性能监控\n */\nexport function performanceMiddleware<T>(threshold = 100) {\n  return async (context: MiddlewareContext<T>, next: NextFunction): Promise<void> => {\n    const start = performance.now()\n\n    await next()\n\n    const duration = performance.now() - start\n    if (duration > threshold) {\n      console.warn(`[Performance] Slow middleware execution: ${duration.toFixed(2)}ms`, context)\n    }\n  }\n}\n\n/**\n * 内置中间件 - 错误处理\n */\nexport function errorHandlingMiddleware<T>(\n  errorHandler?: (error: Error, context: MiddlewareContext<T>) => void\n) {\n  return async (context: MiddlewareContext<T>, next: NextFunction): Promise<void> => {\n    try {\n      await next()\n    } catch (error) {\n      console.error('[Middleware] Error:', error, context)\n      if (errorHandler) {\n        errorHandler(error as Error, context)\n      } else {\n        throw error\n      }\n    }\n  }\n}\n\n/**\n * 内置中间件 - 数据验证\n */\nexport function validationMiddleware<T>(\n  validator: (data: T) => boolean,\n  errorMessage = 'Validation failed'\n) {\n  return async (context: MiddlewareContext<T>, next: NextFunction): Promise<void> => {\n    if (!validator(context.data)) {\n      throw new Error(errorMessage)\n    }\n    await next()\n  }\n}\n\n/**\n * 内置中间件 - 数据转换\n */\nexport function transformMiddleware<T, R>(\n  transformer: (data: T) => R\n): MiddlewareFunction<T> {\n  return async (context: MiddlewareContext<T>, next: NextFunction): Promise<void> => {\n    context.data = transformer(context.data) as T\n    await next()\n  }\n}\n\n/**\n * 内置中间件 - 缓存\n */\nexport function cacheMiddleware<T>(\n  cache: Map<string, unknown>,\n  keyGenerator: (context: MiddlewareContext<T>) => string\n) {\n  return async (context: MiddlewareContext<T>, next: NextFunction): Promise<void> => {\n    const key = keyGenerator(context)\n\n    if (cache.has(key)) {\n      context.data = cache.get(key) as T\n      return\n    }\n\n    await next()\n\n    cache.set(key, context.data)\n  }\n}\n\n/**\n * 内置中间件 - 节流\n */\nexport function throttleMiddleware<T>(delay = 100) {\n  let lastExecutionTime = 0\n\n  return async (context: MiddlewareContext<T>, next: NextFunction): Promise<void> => {\n    const now = Date.now()\n\n    if (now - lastExecutionTime < delay) {\n      return\n    }\n\n    lastExecutionTime = now\n    await next()\n  }\n}\n\n/**\n * 内置中间件 - 防抖\n */\nexport function debounceMiddleware<T>(delay = 300) {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null\n\n  return async (context: MiddlewareContext<T>, next: NextFunction): Promise<void> => {\n    if (timeoutId) {\n      clearTimeout(timeoutId)\n    }\n\n    return new Promise((resolve) => {\n      timeoutId = setTimeout(async () => {\n        await next()\n        resolve()\n      }, delay)\n    })\n  }\n}\n\n"],"names":["a","Object","defineProperty","o","n","e","t","enumerable","configurable","writable","value","d","constructor","__publicField","this","use","middleware","middlewares","push","remove","index","indexOf","splice","clear","execute","context","next","async","length","size","cache","keyGenerator","key","has","data","get","set","delay","timeoutId","clearTimeout","Promise","resolve","setTimeout","errorHandler","error","Date","now","threshold","start","performance","lastExecutionTime","validator","errorMessage","Error"],"mappings":"aAsBO,IAAAA,EAAAC,OAAAC,eAAAC,EAAA,CAAAC,EAAAC,EAAAC,KAAA,EAAAF,EAAAC,EAAAC,KAAAD,KAAAD,EAAAJ,EAAAI,EAAAC,EAAA,CAAAE,YAAA,EAAAC,cAAA,EAAAC,UAAA,EAAAC,MAAAJ,IAAAF,EAAAC,GAAAC,GAAAK,CAAAP,EAAAC,EAAA,GAAAC,GAAAA,6BAAA,MAAA,WAAAM,GACLC,EAAAC,KAAQ,cAAuC,GAAC,CAKhD,GAAAC,CAAIC,GACF,OAAAF,KAAKG,YAAYC,KAAKF,GACfF,IACT,CAKA,MAAAK,CAAOH,GACL,MAAMI,EAAQN,KAAKG,YAAYI,QAAQL,GACvC,OAAc,IAAVI,IACFN,KAAKG,YAAYK,OAAOF,EAAO,IACxB,EAGX,CAKA,KAAAG,GACET,KAAKG,YAAc,EACrB,CAKA,aAAMO,CAAQC,GACZ,IAAIL,EAAQ,EAEZ,MAAMM,EAAOC,UACX,GAAIP,GAASN,KAAKG,YAAYW,OAC5B,OAGF,MAAMZ,EAAaF,KAAKG,YAAYG,WAC9BJ,EAAWS,EAASC,UAGtBA,GACR,CAKA,IAAAG,GACE,OAAOf,KAAKG,YAAYW,MAC1B,2BAqFK,SACLE,EACAC,GAEA,aAAcN,EAA+BC,KAC3C,MAAMM,EAAMD,EAAaN,GAErBK,EAAMG,IAAID,GACZP,EAAQS,KAAOJ,EAAMK,IAAIH,UAIrBN,IAENI,EAAMM,IAAIJ,EAAKP,EAAQS,OAE3B,6BAuBO,SAA+BG,EAAQ,KAC5C,IAAIC,EAAkD,KAEtD,OAAOX,MAAOF,EAA+BC,KACvCY,GACFC,aAAaD,GAGR,IAAIE,QAASC,IAClBH,EAAYI,WAAWf,gBACfD,IACNe,KACCJ,KAGT,kCArGO,SACLM,GAEA,aAAclB,EAA+BC,KAC3C,UACQA,GACR,OAASkB,GAEP,IAAID,QAGIC,EAFND,EAAaC,EAAgBnB,EAIjC,EAEJ,4BA/CO,SACLA,EACAC,GAEcmB,KAAKC,MAGnBpB,IAEiBmB,KAAKC,KAExB,gCAKO,SAAkCC,EAAY,KACnD,aAActB,EAA+BC,KAC3C,MAAMsB,EAAQC,YAAYH,YAEpBpB,IAEWuB,YAAYH,MAKjC,6BAyEO,SAA+BT,EAAQ,KAC5C,IAAIa,EAAoB,EAExB,OAAOvB,MAAOF,EAA+BC,KAC3C,MAAMoB,EAAMD,KAAKC,MAEbA,EAAMI,EAAoBb,IAI9Ba,EAAoBJ,QACdpB,KAEV,wCA5DEyB,EACAC,EAAe,qBAEf,OAAOzB,MAAOF,EAA+BC,KAC3C,IAAKyB,EAAU1B,EAAQS,MACrB,MAAM,IAAImB,MAAMD,SAEZ1B,IAEV"}