{"version":3,"file":"LazyLoader.cjs","sources":["../../src/core/LazyLoader.ts"],"sourcesContent":["/**\n * 懒加载管理器\n * 实现按需加载语言、主题和插件\n */\n\nimport { LRUCache } from '../utils/cache'\n\nexport interface LoaderOptions {\n  retries?: number\n  timeout?: number\n  cache?: boolean\n}\n\nexport type LoaderFunction<T> = () => Promise<T>\n\n/**\n * 懒加载管理器\n */\nexport class LazyLoader {\n  private cache = new LRUCache<unknown>({ maxSize: 50 })\n  private loading = new Map<string, Promise<unknown>>()\n  private loaded = new Set<string>()\n\n  /**\n   * 加载资源\n   */\n  async load<T>(\n    key: string,\n    loader: LoaderFunction<T>,\n    options: LoaderOptions = {}\n  ): Promise<T> {\n    const { retries = 3, timeout = 10000, cache = true } = options\n\n    // 检查缓存\n    if (cache && this.cache.has(key)) {\n      return this.cache.get(key) as T\n    }\n\n    // 检查是否正在加载\n    if (this.loading.has(key)) {\n      return this.loading.get(key) as Promise<T>\n    }\n\n    // 开始加载\n    const loadPromise = this.loadWithRetry(loader, retries, timeout)\n\n    this.loading.set(key, loadPromise)\n\n    try {\n      const result = await loadPromise\n\n      // 缓存结果\n      if (cache) {\n        this.cache.set(key, result)\n      }\n\n      this.loaded.add(key)\n      return result\n    } finally {\n      this.loading.delete(key)\n    }\n  }\n\n  /**\n   * 带重试的加载\n   */\n  private async loadWithRetry<T>(\n    loader: LoaderFunction<T>,\n    retries: number,\n    timeout: number\n  ): Promise<T> {\n    let lastError: Error | null = null\n\n    for (let i = 0; i <= retries; i++) {\n      try {\n        return await this.withTimeout(loader(), timeout)\n      } catch (error) {\n        lastError = error as Error\n        if (i < retries) {\n          await this.delay(Math.pow(2, i) * 1000) // 指数退避\n        }\n      }\n    }\n\n    throw lastError || new Error('Load failed after retries')\n  }\n\n  /**\n   * 超时控制\n   */\n  private withTimeout<T>(promise: Promise<T>, timeout: number): Promise<T> {\n    return Promise.race([\n      promise,\n      new Promise<T>((_, reject) =>\n        setTimeout(() => reject(new Error('Load timeout')), timeout)\n      ),\n    ])\n  }\n\n  /**\n   * 延迟\n   */\n  private delay(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms))\n  }\n\n  /**\n   * 检查是否已加载\n   */\n  isLoaded(key: string): boolean {\n    return this.loaded.has(key)\n  }\n\n  /**\n   * 预加载\n   */\n  async preload<T>(key: string, loader: LoaderFunction<T>, options?: LoaderOptions): Promise<void> {\n    if (this.isLoaded(key)) {\n      return\n    }\n\n    // 使用 requestIdleCallback 在空闲时加载\n    if ('requestIdleCallback' in window) {\n      window.requestIdleCallback(\n        () => {\n          this.load(key, loader, options).catch((error) => {\n            console.warn(`Preload failed for ${key}:`, error)\n          })\n        },\n        { timeout: 5000 }\n      )\n    } else {\n      // 降级到 setTimeout\n      setTimeout(() => {\n        this.load(key, loader, options).catch((error) => {\n          console.warn(`Preload failed for ${key}:`, error)\n        })\n      }, 100)\n    }\n  }\n\n  /**\n   * 批量预加载\n   */\n  async preloadBatch(\n    items: Array<{ key: string; loader: LoaderFunction<unknown>; options?: LoaderOptions }>\n  ): Promise<void> {\n    const promises = items.map((item) => this.preload(item.key, item.loader, item.options))\n    await Promise.allSettled(promises)\n  }\n\n  /**\n   * 清除缓存\n   */\n  clearCache(): void {\n    this.cache.clear()\n  }\n\n  /**\n   * 重置\n   */\n  reset(): void {\n    this.cache.clear()\n    this.loading.clear()\n    this.loaded.clear()\n  }\n\n  /**\n   * 获取统计信息\n   */\n  getStats() {\n    return {\n      cached: this.cache.size(),\n      loading: this.loading.size,\n      loaded: this.loaded.size,\n      cacheStats: this.cache.getStats(),\n    }\n  }\n}\n\n/**\n * 语言懒加载器\n */\nexport class LanguageLazyLoader extends LazyLoader {\n  /**\n   * 加载语言支持\n   */\n  async loadLanguage(language: string): Promise<void> {\n    const key = `language:${language}`\n\n    if (this.isLoaded(key)) {\n      return\n    }\n\n    await this.load(key, async () => {\n      switch (language) {\n        case 'typescript':\n        case 'javascript':\n          return import('monaco-editor/esm/vs/language/typescript/monaco.contribution')\n\n        case 'json':\n          return import('monaco-editor/esm/vs/language/json/monaco.contribution')\n\n        case 'html':\n          return import('monaco-editor/esm/vs/language/html/monaco.contribution')\n\n        case 'css':\n        case 'scss':\n        case 'less':\n          return import('monaco-editor/esm/vs/language/css/monaco.contribution')\n\n        default:\n          console.warn(`Language ${language} not supported for lazy loading`)\n          return null\n      }\n    })\n  }\n\n  /**\n   * 预加载常用语言\n   */\n  async preloadCommonLanguages(): Promise<void> {\n    const commonLanguages = ['typescript', 'javascript', 'json', 'html', 'css']\n\n    await this.preloadBatch(\n      commonLanguages.map((lang) => ({\n        key: `language:${lang}`,\n        loader: () => this.loadLanguage(lang),\n      }))\n    )\n  }\n}\n\n/**\n * 主题懒加载器\n */\nexport class ThemeLazyLoader extends LazyLoader {\n  /**\n   * 加载主题\n   */\n  async loadTheme(themeName: string): Promise<unknown> {\n    const key = `theme:${themeName}`\n\n    return this.load(key, async () => {\n      // 这里可以实现从 CDN 或服务器加载主题\n      console.debug(`Loading theme: ${themeName}`)\n      return null\n    })\n  }\n}\n\n/**\n * 插件懒加载器\n */\nexport class PluginLazyLoader extends LazyLoader {\n  /**\n   * 加载插件\n   */\n  async loadPlugin(pluginName: string): Promise<unknown> {\n    const key = `plugin:${pluginName}`\n\n    return this.load(key, async () => {\n      // 这里可以实现动态导入插件\n      console.debug(`Loading plugin: ${pluginName}`)\n      return null\n    })\n  }\n}\n\n// 导出默认实例\nexport const languageLoader = new LanguageLazyLoader()\nexport const themeLoader = new ThemeLazyLoader()\nexport const pluginLoader = new PluginLazyLoader()\n\n"],"names":["l","Object","defineProperty","n","r","e","a","enumerable","configurable","writable","value","u","LazyLoader","constructor","__publicField","this","LRUCache","maxSize","Map","Set","load","key","loader","options","retries","timeout","cache","has","get","loading","loadPromise","loadWithRetry","set","result","loaded","add","delete","lastError","i","withTimeout","error","delay","Math","pow","Error","promise","Promise","race","_","reject","setTimeout","ms","resolve","isLoaded","preload","window","requestIdleCallback","catch","preloadBatch","items","promises","map","item","allSettled","clearCache","clear","reset","getStats","cached","size","cacheStats","LanguageLazyLoader","loadLanguage","language","async","then","require","preloadCommonLanguages","lang","ThemeLazyLoader","loadTheme","themeName","PluginLazyLoader","loadPlugin","pluginName","languageLoader","themeLoader","pluginLoader"],"mappings":"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"}