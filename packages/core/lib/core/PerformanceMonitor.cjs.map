{"version":3,"file":"PerformanceMonitor.cjs","sources":["../../src/core/PerformanceMonitor.ts"],"sourcesContent":["/**\n * 性能监控器\n * 监控编辑器性能指标\n */\n\nexport interface PerformanceMetric {\n  name: string\n  value: number\n  timestamp: number\n  category: 'load' | 'render' | 'interaction' | 'memory' | 'custom'\n}\n\nexport interface PerformanceReport {\n  metrics: PerformanceMetric[]\n  summary: {\n    totalMetrics: number\n    averageValue: number\n    minValue: number\n    maxValue: number\n  }\n  categories: Record<string, number>\n}\n\n/**\n * 性能监控器类\n */\nexport class PerformanceMonitor {\n  private metrics: PerformanceMetric[] = []\n  private marks = new Map<string, number>()\n  private maxMetrics = 1000\n  private enabled = true\n\n  constructor(maxMetrics = 1000) {\n    this.maxMetrics = maxMetrics\n  }\n\n  /**\n   * 启用监控\n   */\n  enable(): void {\n    this.enabled = true\n  }\n\n  /**\n   * 禁用监控\n   */\n  disable(): void {\n    this.enabled = false\n  }\n\n  /**\n   * 记录性能标记\n   */\n  mark(name: string): void {\n    if (!this.enabled) return\n\n    this.marks.set(name, performance.now())\n\n    if (performance.mark) {\n      performance.mark(name)\n    }\n  }\n\n  /**\n   * 测量性能\n   */\n  measure(\n    name: string,\n    startMark?: string,\n    endMark?: string,\n    category: PerformanceMetric['category'] = 'custom'\n  ): number | null {\n    if (!this.enabled) return null\n\n    try {\n      let duration: number\n\n      if (startMark && this.marks.has(startMark)) {\n        const startTime = this.marks.get(startMark)!\n        const endTime = endMark && this.marks.has(endMark) ? this.marks.get(endMark)! : performance.now()\n        duration = endTime - startTime\n\n        // 使用 Performance API\n        if (performance.measure) {\n          try {\n            performance.measure(name, startMark, endMark)\n          } catch {\n            // 忽略错误\n          }\n        }\n      } else {\n        duration = 0\n      }\n\n      this.recordMetric(name, duration, category)\n      return duration\n    } catch (error) {\n      console.error('Performance measure error:', error)\n      return null\n    }\n  }\n\n  /**\n   * 记录指标\n   */\n  recordMetric(\n    name: string,\n    value: number,\n    category: PerformanceMetric['category'] = 'custom'\n  ): void {\n    if (!this.enabled) return\n\n    const metric: PerformanceMetric = {\n      name,\n      value,\n      timestamp: Date.now(),\n      category,\n    }\n\n    this.metrics.push(metric)\n\n    // 限制指标数量\n    if (this.metrics.length > this.maxMetrics) {\n      this.metrics.shift()\n    }\n  }\n\n  /**\n   * 获取所有指标\n   */\n  getMetrics(): PerformanceMetric[] {\n    return [...this.metrics]\n  }\n\n  /**\n   * 获取指标按类别\n   */\n  getMetricsByCategory(category: PerformanceMetric['category']): PerformanceMetric[] {\n    return this.metrics.filter((m) => m.category === category)\n  }\n\n  /**\n   * 获取指标按名称\n   */\n  getMetricsByName(name: string): PerformanceMetric[] {\n    return this.metrics.filter((m) => m.name === name)\n  }\n\n  /**\n   * 生成性能报告\n   */\n  generateReport(): PerformanceReport {\n    const values = this.metrics.map((m) => m.value)\n    const categories = this.metrics.reduce(\n      (acc, m) => {\n        acc[m.category] = (acc[m.category] || 0) + 1\n        return acc\n      },\n      {} as Record<string, number>\n    )\n\n    return {\n      metrics: this.metrics,\n      summary: {\n        totalMetrics: this.metrics.length,\n        averageValue: values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0,\n        minValue: values.length > 0 ? Math.min(...values) : 0,\n        maxValue: values.length > 0 ? Math.max(...values) : 0,\n      },\n      categories,\n    }\n  }\n\n  /**\n   * 清除所有指标\n   */\n  clear(): void {\n    this.metrics = []\n    this.marks.clear()\n\n    if (performance.clearMarks) {\n      performance.clearMarks()\n    }\n    if (performance.clearMeasures) {\n      performance.clearMeasures()\n    }\n  }\n\n  /**\n   * 监控内存使用\n   */\n  getMemoryUsage(): { usedJSHeapSize: number; totalJSHeapSize: number; limit: number } | null {\n    if ('memory' in performance && (performance as { memory?: unknown }).memory) {\n      const memory = (performance as {\n        memory: {\n          usedJSHeapSize: number\n          totalJSHeapSize: number\n          jsHeapSizeLimit: number\n        }\n      }).memory\n\n      return {\n        usedJSHeapSize: memory.usedJSHeapSize,\n        totalJSHeapSize: memory.totalJSHeapSize,\n        limit: memory.jsHeapSizeLimit,\n      }\n    }\n\n    return null\n  }\n\n  /**\n   * 监控 FPS\n   */\n  monitorFPS(duration = 1000): Promise<number> {\n    return new Promise((resolve) => {\n      let frames = 0\n      let lastTime = performance.now()\n      let animationId: number\n\n      const measureFrame = () => {\n        frames++\n        const currentTime = performance.now()\n\n        if (currentTime - lastTime >= duration) {\n          const fps = (frames * 1000) / (currentTime - lastTime)\n          cancelAnimationFrame(animationId)\n          resolve(fps)\n        } else {\n          animationId = requestAnimationFrame(measureFrame)\n        }\n      }\n\n      animationId = requestAnimationFrame(measureFrame)\n    })\n  }\n\n  /**\n   * 监控长任务\n   */\n  observeLongTasks(threshold = 50): void {\n    if ('PerformanceObserver' in window) {\n      try {\n        const observer = new PerformanceObserver((list) => {\n          for (const entry of list.getEntries()) {\n            if (entry.duration > threshold) {\n              this.recordMetric(`long-task:${entry.name}`, entry.duration, 'interaction')\n            }\n          }\n        })\n\n        observer.observe({ entryTypes: ['longtask', 'measure'] })\n      } catch {\n        // PerformanceObserver 不支持或出错\n      }\n    }\n  }\n\n  /**\n   * 获取导航时间\n   */\n  getNavigationTiming(): Record<string, number> | null {\n    if (!performance.timing) {\n      return null\n    }\n\n    const timing = performance.timing\n    const navigationStart = timing.navigationStart\n\n    return {\n      redirect: timing.redirectEnd - timing.redirectStart,\n      dns: timing.domainLookupEnd - timing.domainLookupStart,\n      tcp: timing.connectEnd - timing.connectStart,\n      request: timing.responseStart - timing.requestStart,\n      response: timing.responseEnd - timing.responseStart,\n      dom: timing.domComplete - timing.domLoading,\n      load: timing.loadEventEnd - timing.loadEventStart,\n      total: timing.loadEventEnd - navigationStart,\n    }\n  }\n\n  /**\n   * 导出指标为 JSON\n   */\n  exportToJSON(): string {\n    return JSON.stringify(this.generateReport(), null, 2)\n  }\n\n  /**\n   * 导出指标为 CSV\n   */\n  exportToCSV(): string {\n    const header = 'Name,Value,Timestamp,Category\\n'\n    const rows = this.metrics.map((m) =>\n      `${m.name},${m.value},${m.timestamp},${m.category}`\n    ).join('\\n')\n\n    return header + rows\n  }\n}\n\n/**\n * 性能监控装饰器\n */\nexport function Measure(category: PerformanceMetric['category'] = 'custom') {\n  return function (\n    target: unknown,\n    propertyKey: string,\n    descriptor: PropertyDescriptor\n  ): PropertyDescriptor {\n    const originalMethod = descriptor.value\n    const monitor = new PerformanceMonitor()\n\n    descriptor.value = async function (this: unknown, ...args: unknown[]) {\n      const startMark = `${propertyKey}-start`\n      const endMark = `${propertyKey}-end`\n\n      monitor.mark(startMark)\n\n      try {\n        const result = await originalMethod.apply(this, args)\n        monitor.mark(endMark)\n        monitor.measure(propertyKey, startMark, endMark, category)\n        return result\n      } catch (error) {\n        monitor.mark(endMark)\n        monitor.measure(`${propertyKey}-error`, startMark, endMark, category)\n        throw error\n      }\n    }\n\n    return descriptor\n  }\n}\n\n// 导出全局实例\nexport const globalPerformanceMonitor = new PerformanceMonitor()\n\n"],"names":["l","Object","defineProperty","c","i","e","r","enumerable","configurable","writable","value","f","PerformanceMonitor","constructor","maxMetrics","__publicField","this","Map","enable","enabled","disable","mark","name","marks","set","performance","now","measure","startMark","endMark","category","duration","has","startTime","get","recordMetric","error","metric","timestamp","Date","metrics","push","length","shift","getMetrics","getMetricsByCategory","filter","m","getMetricsByName","generateReport","values","map","categories","reduce","acc","summary","totalMetrics","averageValue","a","b","minValue","Math","min","maxValue","max","clear","clearMarks","clearMeasures","getMemoryUsage","memory","usedJSHeapSize","totalJSHeapSize","limit","jsHeapSizeLimit","monitorFPS","Promise","resolve","animationId","frames","lastTime","measureFrame","currentTime","fps","cancelAnimationFrame","requestAnimationFrame","observeLongTasks","threshold","window","PerformanceObserver","list","entry","getEntries","observe","entryTypes","getNavigationTiming","timing","navigationStart","redirect","redirectEnd","redirectStart","dns","domainLookupEnd","domainLookupStart","tcp","connectEnd","connectStart","request","responseStart","requestStart","response","responseEnd","dom","domComplete","domLoading","load","loadEventEnd","loadEventStart","total","exportToJSON","JSON","stringify","exportToCSV","join","globalPerformanceMonitor","target","propertyKey","descriptor","originalMethod","monitor","async","args","result","apply"],"mappings":"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"}